---
/**
 * LiquidSwirl Component - SIMPLIFIED VERSION
 * 
 * Efecto de spotlight líquido que sigue el cursor
 * Basado en el patrón exitoso de ChapterDeck y Education
 * 
 * Props:
 * - intensity: número 0-1, qué tan intenso es el efecto
 * - radius: radio del vórtice en px
 * - color: color base del efecto
 */

interface Props {
  intensity?: number;
  radius?: number;
  color?: string;
}

const { intensity = 0.8, radius = 600, color = 'rgba(255,255,255,0.25)' } = Astro.props;
---

<div class="liquid-swirl-wrapper" data-liquid-card>
  {/* Primary spotlight layer (fast) */}
  <div 
    class="liquid-spotlight liquid-spotlight-primary" 
    data-spotlight-primary
    style={`
      --intensity: ${intensity};
      --radius: ${radius}px;
      --spot-color: ${color};
    `}
  ></div>
  
  {/* Secondary spotlight layer (slow, creates depth) */}
  <div 
    class="liquid-spotlight liquid-spotlight-secondary" 
    data-spotlight-secondary
    style={`
      --intensity: ${intensity};
      --radius: ${radius * 1.3}px;
      --spot-color: ${color};
    `}
  ></div>

  {/* Slot para contenido (la tarjeta real) */}
  <slot />
</div>

<style>
  .liquid-swirl-wrapper {
    position: relative;
    display: block;
    width: 100%;
    height: 100%;
  }

  .liquid-spotlight {
    position: absolute;
    inset: 0;
    opacity: 0;
    transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    pointer-events: none;
    border-radius: inherit;
    z-index: 50;
    
    /* Gradiente radial MUY INTENSO - mucho más visible */
    background: radial-gradient(
      var(--radius, 600px) circle at var(--mouse-x, 50%) var(--mouse-y, 50%),
      var(--spot-color) 0%,
      color-mix(in srgb, var(--spot-color) 90%, transparent) 15%,
      color-mix(in srgb, var(--spot-color) 65%, transparent) 35%,
      color-mix(in srgb, var(--spot-color) 30%, transparent) 55%,
      transparent 75%
    );
    
    /* Light mode: screen para glow effect visible */
    filter: blur(1px);
    mix-blend-mode: screen;
  }

  /* Primary layer - fast response, sharp */
  .liquid-spotlight-primary {
    z-index: 51;
    filter: blur(0px);
    animation: pulse-glow 3s ease-in-out infinite;
  }

  /* Secondary layer - slower, more diffuse (depth effect) */
  .liquid-spotlight-secondary {
    z-index: 50;
    filter: blur(3px);
    opacity: 0;
    transition: opacity 0.6s cubic-bezier(0.4, 0, 0.2, 1);
  }

  @keyframes pulse-glow {
    0%, 100% { 
      filter: blur(0px) brightness(1); 
    }
    50% { 
      filter: blur(1px) brightness(1.15); 
    }
  }

  /* Show on hover - MUY VISIBLE */
  .liquid-swirl-wrapper:hover .liquid-spotlight-primary {
    opacity: 1;
  }

  .liquid-swirl-wrapper:hover .liquid-spotlight-secondary {
    opacity: 0.75;
  }

  /* Dark mode - screen mode + brillo blanco adicional */
  :global(:root.dark) .liquid-spotlight {
    background: radial-gradient(
      var(--radius, 600px) circle at var(--mouse-x, 50%) var(--mouse-y, 50%),
      color-mix(in srgb, var(--spot-color) 85%, white 15%) 0%,
      color-mix(in srgb, var(--spot-color) 60%, white 10%) 20%,
      color-mix(in srgb, var(--spot-color) 35%, transparent) 40%,
      color-mix(in srgb, var(--spot-color) 12%, transparent) 60%,
      transparent 80%
    );
    mix-blend-mode: screen;
  }

  :global(:root.dark) .liquid-spotlight-primary {
    animation: pulse-glow-dark 3s ease-in-out infinite;
  }

  @keyframes pulse-glow-dark {
    0%, 100% { 
      filter: blur(0px) brightness(1); 
    }
    50% { 
      filter: blur(1px) brightness(1.25); 
    }
  }

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .liquid-spotlight {
      display: none;
    }
  }
</style>

<script>
  // Initialize spotlight effect with SMOOTH LERP and dual layers
  function initLiquidSpotlight() {
    const cards = document.querySelectorAll('[data-liquid-card]');
    
    cards.forEach(card => {
      const primary = card.querySelector('[data-spotlight-primary]') as HTMLElement;
      const secondary = card.querySelector('[data-spotlight-secondary]') as HTMLElement;
      if (!primary || !secondary) return;

      // Mouse tracking with lerp (smooth interpolation)
      let mouseX = 50;
      let mouseY = 50;
      let currentX = 50;
      let currentY = 50;
      let currentXSlow = 50;
      let currentYSlow = 50;
      let rafId: number | null = null;

      // Lerp function for smooth movement
      const lerp = (start: number, end: number, factor: number) => {
        return start + (end - start) * factor;
      };

      // Animation loop
      const animate = () => {
        // Fast layer (primary) - responsive
        currentX = lerp(currentX, mouseX, 0.15);
        currentY = lerp(currentY, mouseY, 0.15);
        
        // Slow layer (secondary) - creates depth
        currentXSlow = lerp(currentXSlow, mouseX, 0.08);
        currentYSlow = lerp(currentYSlow, mouseY, 0.08);

        // Edge intensity boost (stronger near edges)
        const edgeDistanceX = Math.min(currentX, 100 - currentX);
        const edgeDistanceY = Math.min(currentY, 100 - currentY);
        const edgeFactor = 1 + (1 - Math.min(edgeDistanceX, edgeDistanceY) / 50) * 0.3;

        primary.style.setProperty('--mouse-x', `${currentX}%`);
        primary.style.setProperty('--mouse-y', `${currentY}%`);
        primary.style.setProperty('--edge-boost', String(edgeFactor));
        
        secondary.style.setProperty('--mouse-x', `${currentXSlow}%`);
        secondary.style.setProperty('--mouse-y', `${currentYSlow}%`);

        rafId = requestAnimationFrame(animate);
      };

      card.addEventListener('mousemove', (e) => {
        const rect = card.getBoundingClientRect();
        mouseX = ((e.clientX - rect.left) / rect.width) * 100;
        mouseY = ((e.clientY - rect.top) / rect.height) * 100;
      });

      card.addEventListener('mouseenter', () => {
        primary.style.opacity = '1';
        secondary.style.opacity = '0.6';
        if (!rafId) animate();
      });

      card.addEventListener('mouseleave', () => {
        primary.style.opacity = '0';
        secondary.style.opacity = '0';
        if (rafId) {
          cancelAnimationFrame(rafId);
          rafId = null;
        }
        // Reset positions
        mouseX = 50;
        mouseY = 50;
        currentX = 50;
        currentY = 50;
        currentXSlow = 50;
        currentYSlow = 50;
      });
    });
  }

  // Run on load
  if (typeof document !== 'undefined') {
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initLiquidSpotlight);
    } else {
      initLiquidSpotlight();
    }

    // Reinitialize after view transitions
    document.addEventListener('astro:page-load', initLiquidSpotlight);
  }
</script>
