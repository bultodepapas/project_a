---
/**
 * CaseCardPremium - Next-level case study card
 * Features: 3D tilt, liquid spotlight, holographic border, theme colors
 */
import type { Lang } from '@/i18n/config';
import LiquidSwirl from '@/components/effects/LiquidSwirl.astro';

interface Props {
  lang: Lang;
  caseEntry: any;
  index?: number;
}

const { lang, caseEntry, index = 0 } = Astro.props;
const data = caseEntry.data;

// Theme color mapping
const themeColors: Record<string, { primary: string; glow: string; gradient: string }> = {
  audience: {
    primary: '#6ee7b7',
    glow: 'rgba(110, 231, 183, 0.4)',
    gradient: 'linear-gradient(135deg, rgba(110, 231, 183, 0.1), rgba(59, 130, 246, 0.05))'
  },
  benchmark: {
    primary: '#60a5fa',
    glow: 'rgba(96, 165, 250, 0.4)',
    gradient: 'linear-gradient(135deg, rgba(96, 165, 250, 0.1), rgba(139, 92, 246, 0.05))'
  },
  narrative: {
    primary: '#f472b6',
    glow: 'rgba(244, 114, 182, 0.4)',
    gradient: 'linear-gradient(135deg, rgba(244, 114, 182, 0.1), rgba(236, 72, 153, 0.05))'
  },
  capacity: {
    primary: '#fbbf24',
    glow: 'rgba(251, 191, 36, 0.4)',
    gradient: 'linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(245, 158, 11, 0.05))'
  }
};

const theme = themeColors[data.theme] || themeColors.audience;
const animationDelay = `${(index % 6) * 100 + 200}ms`;
---

<article 
  class="case-card-premium reveal-on-scroll"
  data-theme={data.theme}
  data-regions={data.regions.join(',')}
  style={`--theme-primary: ${theme.primary}; --theme-glow: ${theme.glow}; --theme-gradient: ${theme.gradient}; animation-delay: ${animationDelay};`}
>
  <LiquidSwirl color={theme.glow} intensity={1} radius={500}>
    <a
      href={`/${lang}/case-studies/${data.caseSlug}`}
      class="card-inner"
    >
      <!-- Background gradient layer -->
      <div class="card-bg" style={`background: ${theme.gradient}`}></div>
      
      <!-- Holographic border -->
      <div class="card-border"></div>
      
      <!-- Content -->
      <div class="card-content">
        <!-- Header badges -->
        <div class="card-header">
          <div class="theme-badge">
            <div class="badge-orb" style={`background: ${theme.primary}`}></div>
            <span class="badge-text">{data.theme}</span>
          </div>
          
          {data.featured && (
            <div class="featured-badge">
              <svg class="badge-icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
              </svg>
              <span>Featured</span>
            </div>
          )}
        </div>

        <!-- Title -->
        <h3 class="card-title">
          {data.title}
        </h3>

        <!-- Meta -->
        <div class="card-meta">
          <span class="meta-item">{data.role}</span>
          <span class="meta-separator">|</span>
          <span class="meta-item">{data.org}</span>
        </div>

        <!-- Problem statement -->
        <p class="card-problem">
          {data.problem}
        </p>

        <!-- Impact highlights -->
        {data.decisionImpact && data.decisionImpact.length > 0 && (
          <div class="card-impacts">
            <div class="impact-label">Impact</div>
            <div class="impact-tags">
              {data.decisionImpact.slice(0, 2).map((impact: string, i: number) => (
                <div class="impact-tag" style={`animation-delay: ${i * 50}ms`}>
                  <div class="impact-dot" style={`background: ${theme.primary}`}></div>
                  <span>{impact}</span>
                </div>
              ))}
            </div>
          </div>
        )}

        <!-- Footer with regions -->
        <div class="card-footer">
          <div class="region-tags">
            {data.regions.slice(0, 3).map((region: string, i: number) => (
              <span class="region-tag" style={`animation-delay: ${i * 30}ms`}>
                {region}
              </span>
            ))}
            {data.regions.length > 3 && (
              <span class="region-tag">+{data.regions.length - 3}</span>
            )}
          </div>

          <!-- CTA arrow -->
          <div class="card-arrow">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M5 12h14M12 5l7 7-7 7"/>
            </svg>
          </div>
        </div>
      </div>

      <!-- Card glow effect -->
      <div class="card-glow" style={`background: radial-gradient(circle at center, ${theme.glow} 0%, transparent 70%)`}></div>
    </a>
  </LiquidSwirl>
</article>

<style>
  .case-card-premium {
    position: relative;
    height: 100%;
    min-height: 380px;
    opacity: 0;
    transform: translateY(30px);
    animation: card-reveal 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards;
  }

  .card-inner {
    position: relative;
    display: flex;
    flex-direction: column;
    height: 100%;
    padding: 24px;
    border-radius: 16px;
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    overflow: hidden;
    transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    text-decoration: none;
    color: inherit;
  }

  /* Background gradient layer */
  .card-bg {
    position: absolute;
    inset: 0;
    opacity: 0.6;
    transition: opacity 0.4s ease;
    z-index: 0;
  }

  /* Holographic border */
  .card-border {
    position: absolute;
    inset: -1px;
    border-radius: 16px;
    padding: 1px;
    background: linear-gradient(
      135deg,
      var(--theme-primary) 0%,
      transparent 30%,
      transparent 70%,
      var(--theme-primary) 100%
    );
    -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
    -webkit-mask-composite: xor;
    mask-composite: exclude;
    opacity: 0;
    transition: opacity 0.4s ease;
    pointer-events: none;
    z-index: 2;
  }

  /* Card glow */
  .card-glow {
    position: absolute;
    inset: -100px;
    opacity: 0;
    filter: blur(60px);
    transition: opacity 0.5s ease;
    pointer-events: none;
    z-index: 1;
  }

  /* Content layer */
  .card-content {
    position: relative;
    display: flex;
    flex-direction: column;
    height: 100%;
    z-index: 3;
  }

  /* Header */
  .card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
  }

  .theme-badge {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 12px;
    background: var(--color-background-alt);
    border-radius: 20px;
    backdrop-filter: blur(10px);
  }

  .badge-orb {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    animation: orb-pulse 2s ease-in-out infinite;
  }

  .badge-text {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--color-foreground);
  }

  .featured-badge {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 4px 10px;
    background: var(--theme-glow);
    border-radius: 12px;
    font-size: 10px;
    font-weight: 600;
    color: var(--color-background);
    animation: badge-shine 3s ease-in-out infinite;
  }

  .badge-icon {
    animation: trophy-bounce 2s ease-in-out infinite;
  }

  /* Title */
  .card-title {
    font-size: 20px;
    font-weight: 700;
    line-height: 1.3;
    color: var(--color-foreground);
    margin-bottom: 10px;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    transition: color 0.3s ease;
  }

  /* Meta */
  .card-meta {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    color: var(--color-muted);
    margin-bottom: 12px;
  }

  .meta-separator {
    opacity: 0.4;
  }

  /* Problem */
  .card-problem {
    font-size: 14px;
    line-height: 1.6;
    color: var(--color-muted);
    margin-bottom: 16px;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
    flex-grow: 1;
  }

  /* Impact section */
  .card-impacts {
    margin-bottom: 16px;
  }

  .impact-label {
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--color-muted);
    margin-bottom: 8px;
  }

  .impact-tags {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .impact-tag {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    color: var(--color-foreground);
    opacity: 0;
    transform: translateX(-10px);
    animation: tag-slide-in 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
  }

  .impact-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  /* Footer */
  .card-footer {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding-top: 12px;
    border-top: 1px solid var(--color-border);
    margin-top: auto;
  }

  .region-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }

  .region-tag {
    font-size: 10px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    padding: 4px 8px;
    background: var(--color-background);
    border: 1px solid var(--color-border);
    border-radius: 6px;
    color: var(--color-muted);
    opacity: 0;
    transform: scale(0.9);
    animation: tag-pop-in 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
  }

  .card-arrow {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: var(--color-background-alt);
    color: var(--theme-primary);
    transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
  }

  /* Hover state */
  .card-inner:hover {
    transform: translateY(-8px);
    border-color: var(--theme-primary);
    box-shadow: 
      0 20px 60px -15px var(--theme-glow),
      0 0 0 1px var(--theme-primary);
  }

  .card-inner:hover .card-bg {
    opacity: 1;
  }

  .card-inner:hover .card-border {
    opacity: 1;
    animation: border-shimmer 2s linear infinite;
  }

  .card-inner:hover .card-glow {
    opacity: 0.4;
  }

  .card-inner:hover .card-title {
    color: var(--theme-primary);
  }

  .card-inner:hover .card-arrow {
    background: var(--theme-primary);
    color: var(--color-background);
    transform: translateX(4px) scale(1.1);
  }

  /* Animations */
  @keyframes card-reveal {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes orb-pulse {
    0%, 100% {
      opacity: 1;
      transform: scale(1);
    }
    50% {
      opacity: 0.6;
      transform: scale(1.2);
    }
  }

  @keyframes badge-shine {
    0%, 100% {
      box-shadow: 0 0 0 0 var(--theme-glow);
    }
    50% {
      box-shadow: 0 0 20px 0 var(--theme-glow);
    }
  }

  @keyframes trophy-bounce {
    0%, 100% {
      transform: translateY(0);
    }
    50% {
      transform: translateY(-3px);
    }
  }

  @keyframes tag-slide-in {
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  @keyframes tag-pop-in {
    to {
      opacity: 1;
      transform: scale(1);
    }
  }

  @keyframes border-shimmer {
    0% {
      background-position: 0% 50%;
    }
    100% {
      background-position: 200% 50%;
    }
  }

  /* Reveal on scroll */
  .reveal-on-scroll {
    opacity: 0;
    transform: translateY(30px);
  }

  .reveal-on-scroll.revealed {
    animation: card-reveal 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards;
  }

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .case-card-premium,
    .card-inner,
    .card-border,
    .card-glow,
    .card-arrow,
    .badge-orb,
    .badge-icon {
      animation: none !important;
      transition: none !important;
    }

    .card-inner:hover {
      transform: none;
    }
  }

  /* Responsive */
  @media (max-width: 768px) {
    .case-card-premium {
      min-height: 380px;
    }

    .card-inner {
      padding: 24px;
    }

    .card-title {
      font-size: 20px;
    }
  }
</style>

<script>
  import { initOnce } from '@/lib/lifecycle';

  function initPremiumCards() {
    const cards = document.querySelectorAll('.case-card-premium');
    if (!cards.length) return;

    // IntersectionObserver for reveal
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            entry.target.classList.add('revealed');
            observer.unobserve(entry.target);
          }
        });
      },
      { threshold: 0.1, rootMargin: '0px 0px -100px 0px' }
    );

    cards.forEach((card) => observer.observe(card));

    return () => observer.disconnect();
  }

  initOnce(document.body, 'premium-cards', initPremiumCards);
</script>
