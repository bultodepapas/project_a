---
/**
 * Perspectives Index
 * Filterable list of all articles
 */

import Page from '@/layouts/Page.astro';
import { supportedLangs, type Lang, isValidLang } from '@/i18n/config';
import { t } from '@/i18n';
import { getCollection, type CollectionEntry } from 'astro:content';
import ArticleCard from '@/components/perspectives/ArticleCard.astro';
import ArticleFilters from '@/components/perspectives/ArticleFilters.astro';

// Generate static paths for each language
export function getStaticPaths() {
  return supportedLangs.map((lang) => ({
    params: { lang },
  }));
}

const { lang } = Astro.params;

// Validate language
if (!isValidLang(lang)) {
  return Astro.redirect('/en/perspectives');
}

const typedLang = lang as Lang;

const allArticles: CollectionEntry<'articles'>[] = await getCollection('articles');
const articles = allArticles
  .filter((entry: CollectionEntry<'articles'>) => entry.data.lang === typedLang)
  .sort((a: CollectionEntry<'articles'>, b: CollectionEntry<'articles'>) => {
    // Sort by date (newest first), then by featured
    if (a.data.featured !== b.data.featured) {
      return a.data.featured ? -1 : 1;
    }
    return new Date(b.data.publishDate).getTime() - new Date(a.data.publishDate).getTime();
  });

// Extract unique filter options
const categories = [...new Set(articles.map((a: CollectionEntry<'articles'>) => a.data.category))].sort();

const pageTitle = t(typedLang, 'perspectives.index.title');
const pageDescription = t(typedLang, 'perspectives.index.subtitle');
---

<Page
  title={pageTitle}
  description={pageDescription}
  lang={typedLang}
>
  <div class="section min-h-screen">
    <div class="container">
      <!-- Header -->
      <header class="mb-12 animate-fade-in-up">
        <h1 class="text-3xl md:text-4xl font-bold text-foreground mb-4">
          {t(typedLang, 'perspectives.index.title')}
        </h1>
        <p class="text-lg text-muted max-w-2xl">
          {t(typedLang, 'perspectives.index.subtitle')}
        </p>
      </header>

      <!-- Filters -->
      <div class="animate-fade-in-up" style="animation-delay: 100ms">
        <ArticleFilters
          lang={typedLang}
          categories={categories}
        />
      </div>

      <!-- Articles Grid -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 min-h-[400px]">
        {articles.map((articleEntry: CollectionEntry<'articles'>, index: number) => (
          <div class="h-full animate-fade-in-up" style={`animation-delay: ${(index * 100) + 200}ms`}>
            <ArticleCard
              lang={typedLang}
              articleEntry={articleEntry}
            />
          </div>
        ))}
      </div>

      <!-- No Results Message -->
      <div id="no-results-message" class="hidden py-12 text-center text-muted">
        <p class="text-lg">{t(typedLang, 'perspectives.index.noResults')}</p>
        <button
          class="mt-4 text-accent hover:underline filter-btn"
          data-filter="all"
          data-group="category"
          onclick="document.querySelector('.article-filters .filter-btn[data-filter=\'all\']').click()"
        >
          {t(typedLang, 'perspectives.index.filters.all')}
        </button>
      </div>
    </div>
  </div>
</Page>

<script>
  import { initOnce, initSection } from '@/lib/lifecycle';
  import { createRevealObserver } from '@/lib/ui/animations';

  // Simple reveal animation observer
  function initReveal() {
    const container = document.querySelector('.section');
    initOnce(container, 'perspectives-index-reveal', (root) => {
      return createRevealObserver(root, {
        selector: '.reveal-element',
        threshold: 0.1,
        visibleClass: '',
        onReveal: (el) => {
          el.classList.remove('opacity-0', 'translate-y-4');
          el.classList.add('opacity-100', 'translate-y-0');
        },
      });
    });
  }

  initSection('perspectives-index-reveal-init', initReveal);
</script>
