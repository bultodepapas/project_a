---
/**
 * Case Study Detail Page
 * Individual case study with full details
 */

import Page from '@/layouts/Page.astro';
import { supportedLangs, type Lang, isValidLang } from '@/i18n/config';
import { t } from '@/i18n';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const entries = await getCollection('cases');
  return entries.map((entry) => ({
    params: { lang: entry.data.lang, slug: entry.data.caseSlug },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const { lang, slug } = Astro.params;

if (!isValidLang(lang!) || !slug) {
  return Astro.redirect(`/${lang || 'en'}/case-studies`);
}

const typedLang = lang as Lang;
const caseData = entry.data;
const { Content } = await entry.render();

const caseOrder = ['audience-framework', 'benchmark-system', 'narrative-tracking'];
const allCases = await getCollection('cases');
const casesForLang = caseOrder
  .map((caseSlug) =>
    allCases.find(
      (caseEntry) => caseEntry.data.lang === typedLang && caseEntry.data.caseSlug === caseSlug
    )
  )
  .filter(Boolean);

const currentIndex = casesForLang.findIndex((caseEntry) => caseEntry?.data.caseSlug === caseData.caseSlug);
const prevCase = currentIndex > 0 ? casesForLang[currentIndex - 1] : null;
const nextCase = currentIndex < casesForLang.length - 1 ? casesForLang[currentIndex + 1] : null;
---

<Page
  title={`${caseData.title} | Angela Parra Sanchez`}
  description={caseData.problem.slice(0, 160)}
  lang={typedLang}
  ogType="article"
>
  <article class="section">
    <div class="container max-w-4xl">
      <!-- Breadcrumb -->
      <nav class="mb-8">
        <a href={`/${typedLang}/case-studies`} class="text-sm text-muted hover:text-accent transition-colors">
          &larr; {t(typedLang, 'cases.detail.backToIndex')}
        </a>
      </nav>

      <!-- Header -->
      <header class="mb-12 pb-8 border-b border-border">
        <h1 class="text-3xl md:text-4xl font-bold text-foreground mb-4">{caseData.title}</h1>

        <div class="flex flex-wrap items-center gap-3 text-sm text-muted">
          <span class="inline-flex items-center px-2 py-1 rounded-full bg-accent/10 text-accent text-xs font-medium">
            {caseData.theme}
          </span>
          <span class="text-foreground font-medium">{caseData.role}</span>
          <span class="text-border">|</span>
          <span>{caseData.org}</span>
          <span class="text-border">|</span>
          <span>{caseData.timeframe}</span>
        </div>

        <div class="flex flex-wrap gap-2 mt-4">
          {caseData.regions.map((region) => (
            <span class="px-3 py-1 text-xs font-medium rounded-full bg-accent/10 text-accent">
              {region}
            </span>
          ))}
        </div>
      </header>

      <!-- Problem -->
      <section class="mb-10 p-6 rounded-xl bg-background-alt border border-border">
        <h2 class="text-xl font-semibold text-foreground mb-4">{t(typedLang, 'cases.detail.problem')}</h2>
        <p class="text-muted leading-relaxed">{caseData.problem}</p>
      </section>

      <!-- Approach -->
      <section class="mb-10">
        <h2 class="text-xl font-semibold text-foreground mb-4">{t(typedLang, 'cases.detail.approach')}</h2>
        <ul class="space-y-2">
          {caseData.approach.map((item) => (
            <li class="flex gap-3 text-muted">
              <span class="text-accent">+</span>
              <span>{item}</span>
            </li>
          ))}
        </ul>
      </section>

      <!-- System Design -->
      <section class="mb-10">
        <h2 class="text-xl font-semibold text-foreground mb-4">{t(typedLang, 'cases.detail.systemDesign')}</h2>
        <ul class="space-y-2">
          {caseData.systemDesign.map((item) => (
            <li class="flex gap-3 text-muted">
              <span class="text-accent">+</span>
              <span>{item}</span>
            </li>
          ))}
        </ul>
      </section>

      <!-- Data Sources -->
      <section class="mb-10">
        <h2 class="text-xl font-semibold text-foreground mb-4">{t(typedLang, 'cases.detail.dataSources')}</h2>
        <div class="flex flex-wrap gap-2">
          {caseData.dataSources.map((source) => (
            <span class="px-3 py-1 text-sm rounded-full bg-background-alt text-muted">
              {source}
            </span>
          ))}
        </div>
      </section>

      <!-- Outputs -->
      <section class="mb-10">
        <h2 class="text-xl font-semibold text-foreground mb-4">{t(typedLang, 'cases.detail.outputs')}</h2>
        <ul class="space-y-2">
          {caseData.outputs.map((item) => (
            <li class="flex gap-3 text-muted">
              <span class="text-accent">+</span>
              <span>{item}</span>
            </li>
          ))}
        </ul>
      </section>

      <!-- Decision Impact -->
      <section class="mb-10 p-6 rounded-xl bg-accent/5 border border-accent/20">
        <h2 class="text-xl font-semibold text-foreground mb-4">{t(typedLang, 'cases.detail.decisionImpact')}</h2>
        <ul class="space-y-3">
          {caseData.decisionImpact.map((item) => (
            <li class="flex gap-3 text-foreground">
              <span class="text-accent font-bold">&rarr;</span>
              <span>{item}</span>
            </li>
          ))}
        </ul>
      </section>

      <!-- Adoption -->
      <section class="mb-10">
        <h2 class="text-xl font-semibold text-foreground mb-4">{t(typedLang, 'cases.detail.adoption')}</h2>
        <p class="text-muted leading-relaxed">{caseData.adoption}</p>
      </section>

      <!-- Governance -->
      <section class="mb-10">
        <h2 class="text-xl font-semibold text-foreground mb-4">{t(typedLang, 'cases.detail.governance')}</h2>
        <p class="text-muted leading-relaxed">{caseData.governance}</p>
      </section>

      <!-- Tools -->
      <section class="mb-12">
        <h2 class="text-xl font-semibold text-foreground mb-4">{t(typedLang, 'cases.detail.tools')}</h2>
        <div class="flex flex-wrap gap-2">
          {caseData.tools.map((tool) => (
            <span class="px-3 py-1 text-sm rounded-full bg-primary/5 text-primary">
              {tool}
            </span>
          ))}
        </div>
      </section>

      <!-- MDX Content -->
      <section class="mb-12 prose">
        <Content />
      </section>

      <!-- Navigation -->
      <nav class="flex items-center justify-between pt-8 border-t border-border">
        {prevCase ? (
          <a href={`/${typedLang}/case-studies/${prevCase.data.caseSlug}`} class="text-sm text-muted hover:text-accent transition-colors">
            &larr; {t(typedLang, 'cases.detail.prevCase')}
          </a>
        ) : <span />}

        {nextCase ? (
          <a href={`/${typedLang}/case-studies/${nextCase.data.caseSlug}`} class="text-sm text-muted hover:text-accent transition-colors">
            {t(typedLang, 'cases.detail.nextCase')} &rarr;
          </a>
        ) : <span />}
      </nav>
    </div>
  </article>
</Page>
