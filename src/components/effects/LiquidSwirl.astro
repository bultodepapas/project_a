---
/**
 * LiquidSwirl - Spotlight hover effect with smooth liquid motion
 * Based on the proven ArticleCard spotlight implementation
 */
interface Props {
  intensity?: number;
  radius?: number;
  color: string;
}

const { intensity = 1, radius = 600, color } = Astro.props;
---

<div class="liquid-swirl-container" data-swirl-radius={radius} data-swirl-color={color}>
  <slot />
  
  <!-- Spotlight effect layer -->
  <div class="liquid-spotlight" style={`--swirl-color: ${color}; --swirl-radius: ${radius}px; --swirl-intensity: ${intensity};`}></div>
</div>

<style>
  .liquid-swirl-container {
    position: relative;
    border-radius: 1rem;
  }

  .liquid-spotlight {
    position: absolute;
    inset: 0;
    border-radius: 1rem;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.3s ease;
    background: radial-gradient(
      var(--swirl-radius) circle at var(--mouse-x, 50%) var(--mouse-y, 50%),
      var(--swirl-color),
      transparent 50%
    );
    z-index: 5;
    filter: blur(30px);
  }

  .liquid-swirl-container:hover .liquid-spotlight {
    opacity: 1;
  }

  /* Reduced motion support */
  @media (prefers-reduced-motion: reduce) {
    .liquid-spotlight {
      transition: none;
    }
  }
</style>

<script>
  function initLiquidSwirl() {
    const containers = document.querySelectorAll('.liquid-swirl-container');
    
    containers.forEach((container) => {
      const spotlight = container.querySelector('.liquid-spotlight') as HTMLElement;
      if (!spotlight) return;

      // Check for reduced motion
      const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      if (prefersReducedMotion) return;

      // Smooth mouse tracking with lerp (linear interpolation)
      let currentX = 0.5;
      let currentY = 0.5;
      let targetX = 0.5;
      let targetY = 0.5;
      let rafId: number | null = null;

      const lerp = (start: number, end: number, factor: number) => {
        return start + (end - start) * factor;
      };

      const updatePosition = () => {
        // Smooth interpolation
        currentX = lerp(currentX, targetX, 0.15);
        currentY = lerp(currentY, targetY, 0.15);

        // Update CSS custom properties
        spotlight.style.setProperty('--mouse-x', `${currentX * 100}%`);
        spotlight.style.setProperty('--mouse-y', `${currentY * 100}%`);

        // Continue animation if position hasn't settled
        const delta = Math.abs(currentX - targetX) + Math.abs(currentY - targetY);
        if (delta > 0.001) {
          rafId = requestAnimationFrame(updatePosition);
        } else {
          rafId = null;
        }
      };

      container.addEventListener('mousemove', (e) => {
        const event = e as MouseEvent;
        const rect = (container as HTMLElement).getBoundingClientRect();
        
        // Calculate target position (normalized 0-1)
        targetX = (event.clientX - rect.left) / rect.width;
        targetY = (event.clientY - rect.top) / rect.height;

        // Start animation loop if not already running
        if (rafId === null) {
          rafId = requestAnimationFrame(updatePosition);
        }
      });

      container.addEventListener('mouseleave', () => {
        // Reset to center on leave
        targetX = 0.5;
        targetY = 0.5;
        if (rafId === null) {
          rafId = requestAnimationFrame(updatePosition);
        }
      });
    });
  }

  // Initialize on page load
  if (typeof document !== 'undefined') {
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initLiquidSwirl);
    } else {
      initLiquidSwirl();
    }

    // Reinitialize after view transitions
    document.addEventListener('astro:page-load', initLiquidSwirl);
  }
</script>
