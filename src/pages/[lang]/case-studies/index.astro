---
/**
 * Case Studies Index
 * Filterable list of all case studies
 */

import Page from '@/layouts/Page.astro';
import { supportedLangs, type Lang, isValidLang } from '@/i18n/config';
import { t } from '@/i18n';
import { getCollection, type CollectionEntry } from 'astro:content';
import CaseCard from '@/components/cases/CaseCard.astro';
import CaseFilters from '@/components/cases/CaseFilters.astro';

// Generate static paths for each language
export function getStaticPaths() {
  return supportedLangs.map((lang) => ({
    params: { lang },
  }));
}

const { lang } = Astro.params;

// Validate language
if (!isValidLang(lang)) {
  return Astro.redirect('/en/case-studies');
}

const typedLang = lang as Lang;

const allCases: CollectionEntry<'cases'>[] = await getCollection('cases');
const cases = allCases
  .filter((entry: CollectionEntry<'cases'>) => entry.data.lang === typedLang)
  .sort((a: CollectionEntry<'cases'>, b: CollectionEntry<'cases'>) => {
    if (a.data.featured === b.data.featured) {
      return a.data.caseSlug.localeCompare(b.data.caseSlug);
    }
    return a.data.featured ? -1 : 1;
  });

// Extract unique filter options
const themes = [...new Set(cases.map((c: CollectionEntry<'cases'>) => c.data.theme))].sort();
const regions = [...new Set(cases.flatMap((c: CollectionEntry<'cases'>) => c.data.regions))].sort();

const pageTitle = t(typedLang, 'cases.index.title');
const pageDescription = t(typedLang, 'cases.index.subtitle');
---

<Page
  title={pageTitle}
  description={pageDescription}
  lang={typedLang}
>
  <div class="section min-h-screen">
    <div class="container">
      <!-- Header -->
      <header class="mb-12 animate-fade-in-up">
        <h1 class="text-3xl md:text-4xl font-bold text-foreground mb-4">
          {t(typedLang, 'cases.index.title')}
        </h1>
        <p class="text-lg text-muted max-w-2xl">
          {t(typedLang, 'cases.index.subtitle')}
        </p>
      </header>

      <!-- Filters -->
      <div class="animate-fade-in-up" style="animation-delay: 100ms">
        <CaseFilters 
          lang={typedLang} 
          themes={themes} 
          regions={regions} 
        />
      </div>

      <!-- Case Grid -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 min-h-[400px]">
        {cases.map((caseEntry: CollectionEntry<'cases'>, index: number) => (
          <div class="h-full animate-fade-in-up" style={`animation-delay: ${(index * 100) + 200}ms`}>
            <CaseCard 
              lang={typedLang} 
              caseEntry={caseEntry} 
            />
          </div>
        ))}
      </div>

      <!-- No Results Message -->
      <div id="no-results-message" class="hidden py-12 text-center text-muted">
        <p class="text-lg">{t(typedLang, 'cases.index.noResults')}</p>
        <button 
          class="mt-4 text-accent hover:underline filter-btn" 
          data-filter="all" 
          data-group="theme"
          onclick="document.querySelector('.filter-btn[data-filter=\'all\']').click()"
        >
          {t(typedLang, 'cases.index.filters.all')}
        </button>
      </div>
    </div>
  </div>
</Page>

<script>
  import { initOnce, initSection } from '@/lib/lifecycle';
  import { createRevealObserver } from '@/lib/ui/animations';

  // Simple reveal animation observer
  function initReveal() {
    const container = document.querySelector('.section');
    initOnce(container, 'cases-index-reveal', (root) => {
      return createRevealObserver(root, {
        selector: '.reveal-element',
        threshold: 0.1,
        visibleClass: '',
        onReveal: (el) => {
          el.classList.remove('opacity-0', 'translate-y-4');
          el.classList.add('opacity-100', 'translate-y-0');
        },
      });
    });
  }
  
  initSection('cases-index-reveal-init', initReveal);
</script>
