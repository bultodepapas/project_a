---
/**
 * Header Component
 * Main navigation with language switch
 */

import { type Lang, getLocalizedPath } from '@/i18n/config';
import { t } from '@/i18n';
import LangSwitch from '@/components/core/LangSwitch.astro';
import ThemeToggle from '@/components/core/ThemeToggle.astro';

export interface Props {
  lang: Lang;
  currentPath: string;
}

const { lang, currentPath } = Astro.props;

const normalizedPath = currentPath.endsWith('/') && currentPath.length > 1
  ? currentPath.slice(0, -1)
  : currentPath;
const homePath = `/${lang}`;
const isHome = normalizedPath === homePath;
const homeAnchor = (hash: string) => (isHome ? `#${hash}` : `${homePath}#${hash}`);

// Navigation items
const navItems = [
  { key: 'systems', href: homeAnchor('systems') },
  { key: 'caseStudies', href: `/${lang}/case-studies` },
  { key: 'perspectives', href: `/${lang}/perspectives` },
  { key: 'contact', href: homeAnchor('contact') },
];
---

<header
  class="fixed top-0 left-0 right-0 z-40 bg-background/70 backdrop-blur-md border-b border-border/40 shadow-sm"
>
  <div class="container">
    <nav class="flex items-center justify-between h-16 md:h-20">
      <!-- Logo / Name -->
      <a
        href={`/${lang}`}
        class="font-display font-semibold text-lg text-foreground hover:text-accent transition-colors"
      >
        Angela Parra
      </a>

      <!-- Desktop Navigation -->
      <div class="hidden md:flex items-center gap-6 lg:gap-8">
        {
          navItems.map((item) => (
            <a
              href={item.href}
              class="header-link magnet-target text-sm font-medium text-muted hover:text-foreground transition-colors"
              data-magnet
            >
              {t(lang, `nav.${item.key}`)}
            </a>
          ))
        }

        <!-- Language Switch -->
        <div class="flex items-center gap-2 border-l border-border pl-4">
           <ThemeToggle lang={lang} />
           <LangSwitch currentLang={lang} currentPath={currentPath} />
        </div>

        <!-- Resume CTA -->
        <a
          href={`/${lang}/resume`}
          class="header-cta magnet-target inline-flex items-center justify-center px-4 py-2 text-sm font-medium rounded-md border border-accent text-accent hover:bg-accent hover:text-white transition-colors ml-2"
          data-magnet
        >
          {t(lang, 'nav.resume')}
        </a>
      </div>

      <!-- Mobile Menu Button -->
      <div class="flex items-center gap-2 md:hidden">
        <ThemeToggle lang={lang} />
        <button
          type="button"
          class="p-2 text-muted hover:text-foreground transition-colors"
          aria-label={t(lang, 'a11y.menuToggle')}
          data-menu-toggle
        >
          <svg
            class="w-6 h-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
            aria-hidden="true"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
        </button>
      </div>
    </nav>
  </div>

  <!-- Mobile Menu -->
  <div
    class="md:hidden hidden border-t border-border bg-background"
    data-mobile-menu
  >
    <div class="container py-4 space-y-4">
      {
        navItems.map((item) => (
          <a
            href={item.href}
            class="block py-2 text-base font-medium text-muted hover:text-foreground transition-colors"
          >
            {t(lang, `nav.${item.key}`)}
          </a>
        ))
      }

      <!-- Language Switch Mobile -->
      <div class="py-2 border-t border-border">
         <div class="flex items-center gap-2">
            <span class="text-sm text-muted">{t(lang, 'a11y.languageSwitch')}:</span>
            <LangSwitch currentLang={lang} currentPath={currentPath} />
         </div>
      </div>
    </div>
  </div>
</header>

<style>
  .magnet-target {
    position: relative;
    transition: transform 0.2s ease, color 0.2s ease, box-shadow 0.2s ease;
    transform: translate3d(0, 0, 0);
    will-change: transform;
  }

  .magnet-target::after {
    content: '';
    position: absolute;
    inset: -6px;
    border-radius: inherit;
    background: radial-gradient(
      120px circle at var(--mx, 50%) var(--my, 50%),
      rgba(63, 159, 119, 0.18),
      transparent 65%
    );
    opacity: 0;
    transition: opacity 0.2s ease;
    pointer-events: none;
    z-index: -1;
  }

  .magnet-target:hover::after {
    opacity: 1;
  }

  .header-cta {
    box-shadow: 0 8px 18px rgba(24, 89, 64, 0.08);
  }

  .header-cta:hover {
    box-shadow: 0 12px 26px rgba(24, 89, 64, 0.16);
  }

  @media (prefers-reduced-motion: reduce) {
    .magnet-target {
      transition: color 0.2s ease, box-shadow 0.2s ease;
    }
  }
</style>

<script>
  // Mobile menu toggle
  const menuToggle = document.querySelector('[data-menu-toggle]');
  const mobileMenu = document.querySelector('[data-mobile-menu]');

  menuToggle?.addEventListener('click', () => {
    mobileMenu?.classList.toggle('hidden');
  });

  // Close menu when clicking on a link
  mobileMenu?.querySelectorAll('a').forEach((link) => {
    link.addEventListener('click', () => {
      mobileMenu?.classList.add('hidden');
    });
  });

  function initHeaderMagnet() {
    const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    const hasFinePointer = window.matchMedia('(pointer: fine)').matches;
    if (prefersReducedMotion || !hasFinePointer) return;

    const targets = document.querySelectorAll<HTMLElement>('.magnet-target[data-magnet]');

    targets.forEach((el) => {
      el.addEventListener('mouseenter', () => {
        el.style.transition = 'transform 0.12s ease-out';
      });

      el.addEventListener('mousemove', (e: MouseEvent) => {
        const rect = el.getBoundingClientRect();
        const x = e.clientX - rect.left - rect.width / 2;
        const y = e.clientY - rect.top - rect.height / 2;
        const mx = ((e.clientX - rect.left) / rect.width) * 100;
        const my = ((e.clientY - rect.top) / rect.height) * 100;

        el.style.setProperty('--mx', `${mx}%`);
        el.style.setProperty('--my', `${my}%`);
        el.style.transform = `translate3d(${x * 0.12}px, ${y * 0.12}px, 0)`;
      });

      el.addEventListener('mouseleave', () => {
        el.style.transition = 'transform 0.3s ease-out';
        el.style.transform = 'translate3d(0, 0, 0)';
      });
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initHeaderMagnet);
  } else {
    initHeaderMagnet();
  }
</script>
