---
/**
 * Case Studies Index - PREMIUM EDITION
 * Epic showcase of strategic intelligence with cinematic effects
 */

import Page from '@/layouts/Page.astro';
import { t } from '@/i18n';
import { getCollection, type CollectionEntry } from 'astro:content';
import CaseStudiesHero from '@/components/cases/CaseStudiesHero.astro';
import CaseStudiesAtmosphere from '@/components/cases/CaseStudiesAtmosphere.astro';
import CaseFiltersAdvanced from '@/components/cases/CaseFiltersAdvanced.astro';
import CaseCardPremium from '@/components/cases/CaseCardPremium.astro';
import { getLangOrRedirect, getLangStaticPaths } from '@/lib/i18n-routing';

// Generate static paths for each language
export function getStaticPaths() {
  return getLangStaticPaths();
}

const { lang } = Astro.params;

const { lang: typedLang, redirect } = getLangOrRedirect(lang, '/en/case-studies');
if (redirect) {
  return Astro.redirect(redirect);
}

const allCases: CollectionEntry<'cases'>[] = await getCollection('cases');
const cases = allCases
  .filter((entry: CollectionEntry<'cases'>) => entry.data.lang === typedLang)
  .sort((a: CollectionEntry<'cases'>, b: CollectionEntry<'cases'>) => {
    if (a.data.featured === b.data.featured) {
      return a.data.caseSlug.localeCompare(b.data.caseSlug);
    }
    return a.data.featured ? -1 : 1;
  });

// Extract unique filter options
const themes = [...new Set(cases.map((c: CollectionEntry<'cases'>) => c.data.theme))].sort();
const regions = [...new Set(cases.flatMap((c: CollectionEntry<'cases'>) => c.data.regions))].sort();

// Calculate stats
const totalRegions = regions.length;

const pageTitle = t(typedLang, 'cases.index.title');
const pageDescription = t(typedLang, 'cases.index.subtitle');
---

<Page
  title={pageTitle}
  description={pageDescription}
  lang={typedLang}
>
  <!-- Atmospheric background -->
  <CaseStudiesAtmosphere />

  <!-- Hero section -->
  <CaseStudiesHero 
    lang={typedLang} 
    totalCases={cases.length}
    totalRegions={totalRegions}
    themes={themes}
  />

  <!-- Main content section -->
  <div class="cases-showcase-section section relative">
    <div class="container">
      <!-- Advanced Filters -->
      <CaseFiltersAdvanced 
        lang={typedLang} 
        themes={themes} 
        regions={regions} 
      />

      <!-- Case Grid with Premium Cards -->
      <div class="cases-grid">
        {cases.map((caseEntry: CollectionEntry<'cases'>, index: number) => (
          <CaseCardPremium 
            lang={typedLang} 
            caseEntry={caseEntry}
            index={index}
          />
        ))}
      </div>

      <!-- No Results Message -->
      <div id="no-results-message" class="no-results-message">
        <div class="no-results-icon">
          <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <circle cx="12" cy="12" r="10"/>
            <path d="M8 12h8M12 8v8"/>
          </svg>
        </div>
        <h3 class="no-results-title">No cases match your filters</h3>
        <p class="no-results-text">Try adjusting your filters or reset to see all cases</p>
      </div>
    </div>
  </div>
</Page>

<style>
  .cases-showcase-section {
    position: relative;
    z-index: 10;
    padding: 40px 0 80px;
  }

  .cases-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
    gap: 24px;
    min-height: 400px;
  }

  /* No results message */
  .no-results-message {
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 80px 20px;
    text-align: center;
  }

  .no-results-icon {
    width: 80px;
    height: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 24px;
    color: var(--color-muted);
    opacity: 0.5;
  }

  .no-results-title {
    font-size: 24px;
    font-weight: 700;
    color: var(--color-foreground);
    margin-bottom: 12px;
  }

  .no-results-text {
    font-size: 16px;
    color: var(--color-muted);
    max-width: 400px;
  }

  @media (max-width: 1200px) {
    .cases-grid {
      grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
      gap: 24px;
    }
  }

  @media (max-width: 768px) {
    .cases-showcase-section {
      padding: 60px 0 80px;
    }

    .cases-grid {
      grid-template-columns: 1fr;
      gap: 24px;
    }
  }
</style>
