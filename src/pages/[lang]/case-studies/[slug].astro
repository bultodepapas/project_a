---
/**
 * Case Study Detail Page
 * Individual case study with full details
 */

import Page from '@/layouts/Page.astro';
import { type Lang, isValidLang } from '@/i18n/config';
import { t } from '@/i18n';
import { getCollection, type CollectionEntry } from 'astro:content';
import CaseHeader from '@/components/cases/CaseHeader.astro';
import CaseSection from '@/components/cases/CaseSection.astro';
import CaseNav from '@/components/cases/CaseNav.astro';

export interface Props {
  entry: CollectionEntry<'cases'>;
}

export async function getStaticPaths() {
  const entries: CollectionEntry<'cases'>[] = await getCollection('cases');
  return entries.map((entry) => ({
    params: { lang: entry.data.lang, slug: entry.data.caseSlug },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const { lang, slug } = Astro.params;

if (!isValidLang(lang!) || !slug) {
  return Astro.redirect(`/${lang || 'en'}/case-studies`);
}

const typedLang = lang as Lang;
const caseData = entry.data;
const { Content } = await entry.render();

const caseOrder = ['audience-framework', 'benchmark-system', 'narrative-tracking'];
const allCases = await getCollection('cases');
const casesForLang = caseOrder
  .map((caseSlug) =>
    allCases.find(
      (caseEntry: CollectionEntry<'cases'>) => caseEntry.data.lang === typedLang && caseEntry.data.caseSlug === caseSlug
    )
  )
  .filter((c): c is CollectionEntry<'cases'> => !!c);

const currentIndex = casesForLang.findIndex((caseEntry) => caseEntry.data.caseSlug === caseData.caseSlug);
const prevCaseEntry = currentIndex > 0 ? casesForLang[currentIndex - 1] : null;
const nextCaseEntry = currentIndex < casesForLang.length - 1 ? casesForLang[currentIndex + 1] : null;

const prevCase = prevCaseEntry ? { slug: prevCaseEntry.data.caseSlug, title: prevCaseEntry.data.title } : undefined;
const nextCase = nextCaseEntry ? { slug: nextCaseEntry.data.caseSlug, title: nextCaseEntry.data.title } : undefined;
---

<Page
  title={`${caseData.title} | Angela Parra Sanchez`}
  description={caseData.problem.slice(0, 160)}
  lang={typedLang}
  ogType="article"
>
  <article class="section">
    <div class="container max-w-4xl">
      <!-- Breadcrumb -->
      <nav class="mb-8">
        <a href={`/${typedLang}/case-studies`} class="text-sm text-muted hover:text-accent transition-colors">
          &larr; {t(typedLang, 'cases.detail.backToIndex')}
        </a>
      </nav>

      <CaseHeader 
        title={caseData.title}
        theme={caseData.theme}
        role={caseData.role}
        org={caseData.org}
        timeframe={caseData.timeframe}
        regions={caseData.regions}
      />

      <!-- Problem -->
      <CaseSection title={t(typedLang, 'cases.detail.problem')} variant="boxed">
        <p class="text-muted leading-relaxed">{caseData.problem}</p>
      </CaseSection>

      <!-- Approach -->
      <CaseSection title={t(typedLang, 'cases.detail.approach')}>
        <ul class="space-y-2">
          {caseData.approach.map((item: string) => (
            <li class="flex gap-3 text-muted">
              <span class="text-accent">+</span>
              <span>{item}</span>
            </li>
          ))}
        </ul>
      </CaseSection>

      <!-- System Design -->
      <CaseSection title={t(typedLang, 'cases.detail.systemDesign')}>
        <ul class="space-y-2">
          {caseData.systemDesign.map((item: string) => (
            <li class="flex gap-3 text-muted">
              <span class="text-accent">+</span>
              <span>{item}</span>
            </li>
          ))}
        </ul>
      </CaseSection>

      <!-- Data Sources -->
      <CaseSection title={t(typedLang, 'cases.detail.dataSources')}>
        <div class="flex flex-wrap gap-2">
          {caseData.dataSources.map((source: string) => (
            <span class="px-3 py-1 text-sm rounded-full bg-background-alt text-muted border border-border">
              {source}
            </span>
          ))}
        </div>
      </CaseSection>

      <!-- Outputs -->
      <CaseSection title={t(typedLang, 'cases.detail.outputs')}>
        <ul class="space-y-2">
          {caseData.outputs.map((item: string) => (
            <li class="flex gap-3 text-muted">
              <span class="text-accent">+</span>
              <span>{item}</span>
            </li>
          ))}
        </ul>
      </CaseSection>

      <!-- Decision Impact (Highlighted) -->
      <CaseSection title={t(typedLang, 'cases.detail.decisionImpact')} variant="highlight">
        <ul class="space-y-3">
          {caseData.decisionImpact.map((item: string) => (
            <li class="flex gap-3 text-foreground">
              <span class="text-accent font-bold">&rarr;</span>
              <span>{item}</span>
            </li>
          ))}
        </ul>
      </CaseSection>

      <!-- Adoption -->
      <CaseSection title={t(typedLang, 'cases.detail.adoption')}>
        <p class="text-muted leading-relaxed">{caseData.adoption}</p>
      </CaseSection>

      <!-- Governance -->
      <CaseSection title={t(typedLang, 'cases.detail.governance')}>
        <p class="text-muted leading-relaxed">{caseData.governance}</p>
      </CaseSection>

      <!-- Tools -->
      <CaseSection title={t(typedLang, 'cases.detail.tools')}>
        <div class="flex flex-wrap gap-2">
          {caseData.tools.map((tool: string) => (
            <span class="px-3 py-1 text-sm rounded-full bg-primary/5 text-primary">
              {tool}
            </span>
          ))}
        </div>
      </CaseSection>

      <!-- MDX Content -->
      <div class="mb-12 prose prose-neutral dark:prose-invert max-w-none">
        <Content />
      </div>

      <CaseNav 
        lang={typedLang}
        prevCase={prevCase}
        nextCase={nextCase}
      />
    </div>
  </article>
</Page>
