---
import { t } from '@/i18n';
import type { Lang } from '@/i18n/config';

interface HiredForItem {
  key: string;
  caseSlug: string;
  icon: string;
  color: string;
  gradient: string;
  metric: string;
  metricLabel: Record<string, string>;
  highlights: Array<Record<string, string>>;
  tools: string[];
}

interface Props {
  lang: Lang;
  items: HiredForItem[];
}

const { lang, items } = Astro.props;

// Helper to get localized string
const getStr = (obj: any) => (typeof obj === 'string' ? obj : obj[lang] || obj.en);

// Icon SVG paths
const iconPaths: Record<string, string> = {
  database: 'M12 2C6.48 2 2 4.69 2 8v8c0 3.31 4.48 6 10 6s10-2.69 10-6V8c0-3.31-4.48-6-10-6zm0 14c-4.42 0-8-1.79-8-4v-2.55c1.94 1.38 4.82 2.05 8 2.05s6.06-.67 8-2.05V12c0 2.21-3.58 4-8 4zm0-6c-4.42 0-8-1.79-8-4s3.58-4 8-4 8 1.79 8 4-3.58 4-8 4z',
  trendingUp: 'M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z',
  barChart: 'M5 9.2h3V19H5V9.2zM10.6 5h2.8v14h-2.8V5zm5.6 8H19v6h-2.8v-6z'
};
---

<section class="relative py-24 md:py-32 overflow-hidden" id="hired-for">
  <!-- Animated background layers -->
  <div class="absolute inset-0 pointer-events-none">
    <!-- Gradient mesh background -->
    <div class="absolute inset-0 bg-gradient-to-b from-background via-background-alt/30 to-background"></div>

    <!-- Animated gradient orbs -->
    <div class="orb-1 absolute w-[600px] h-[600px] rounded-full blur-3xl opacity-20"
         style="background: radial-gradient(circle, #6ee7b7 0%, transparent 70%); top: -10%; left: -10%;"></div>
    <div class="orb-2 absolute w-[500px] h-[500px] rounded-full blur-3xl opacity-15"
         style="background: radial-gradient(circle, #93c5fd 0%, transparent 70%); top: 50%; right: -15%;"></div>
    <div class="orb-3 absolute w-[400px] h-[400px] rounded-full blur-3xl opacity-15"
         style="background: radial-gradient(circle, #c4b5fd 0%, transparent 70%); bottom: -10%; left: 30%;"></div>

    <!-- Animated grid pattern -->
    <svg class="absolute inset-0 w-full h-full opacity-[0.03]" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <pattern id="hired-grid" width="60" height="60" patternUnits="userSpaceOnUse">
          <path d="M 60 0 L 0 0 0 60" fill="none" stroke="currentColor" stroke-width="1"/>
        </pattern>
      </defs>
      <rect width="100%" height="100%" fill="url(#hired-grid)" />
    </svg>

    <!-- Floating particles -->
    <div class="particles-container absolute inset-0">
      {Array.from({ length: 30 }).map(() => (
        <div
          class="particle absolute w-1 h-1 rounded-full bg-accent/40"
          style={`
            left: ${Math.random() * 100}%;
            top: ${Math.random() * 100}%;
            animation: float-particle ${8 + Math.random() * 6}s ease-in-out infinite;
            animation-delay: ${Math.random() * 5}s;
          `}
        />
      ))}
    </div>
  </div>

  <div class="container relative z-10">
    <!-- Premium Header -->
    <div class="text-center mb-20 reveal-element opacity-0 translate-y-8">
      <!-- Eyebrow badge -->
      <div class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-accent/10 border border-accent/20 mb-6">
        <span class="relative flex h-2 w-2">
          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-accent opacity-75"></span>
          <span class="relative inline-flex rounded-full h-2 w-2 bg-accent"></span>
        </span>
        <span class="text-sm font-medium text-accent">
          {lang === 'es' ? 'Mi Propuesta de Valor' : lang === 'fr' ? 'Ma Proposition de Valeur' : lang === 'pt' ? 'Minha Proposta de Valor' : 'My Value Proposition'}
        </span>
      </div>

      <!-- Main title with gradient -->
      <h2 class="text-4xl md:text-5xl lg:text-6xl font-bold mb-6">
        <span class="bg-gradient-to-r from-foreground via-foreground to-muted bg-clip-text">
          {t(lang, 'hiredFor.title')}
        </span>
      </h2>

      <!-- Subtitle -->
      <p class="text-lg md:text-xl text-muted max-w-3xl mx-auto">
        {lang === 'es' ? 'Sistemas probados que transforman datos en decisiones estratégicas' :
         lang === 'fr' ? 'Systèmes éprouvés qui transforment les données en décisions stratégiques' :
         lang === 'pt' ? 'Sistemas comprovados que transformam dados em decisões estratégicas' :
         'Proven systems that transform data into strategic decisions'}
      </p>

      <!-- Decorative line -->
      <div class="mt-8 flex items-center justify-center gap-2">
        <div class="h-px w-16 bg-gradient-to-r from-transparent to-accent/50"></div>
        <div class="w-2 h-2 rotate-45 bg-accent/50"></div>
        <div class="h-px w-16 bg-gradient-to-l from-transparent to-accent/50"></div>
      </div>
    </div>

    <!-- Cards with 3D perspective container -->
    <div class="perspective-container relative" style="perspective: 1500px;">
      <!-- Connection lines (SVG) - Desktop only -->
      <svg class="connection-lines absolute inset-0 w-full h-full pointer-events-none hidden lg:block" style="z-index: 0;">
        <defs>
          <linearGradient id="line-gradient-1" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" style="stop-color: #6ee7b7; stop-opacity: 0.5" />
            <stop offset="100%" style="stop-color: #93c5fd; stop-opacity: 0.5" />
          </linearGradient>
          <linearGradient id="line-gradient-2" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" style="stop-color: #93c5fd; stop-opacity: 0.5" />
            <stop offset="100%" style="stop-color: #c4b5fd; stop-opacity: 0.5" />
          </linearGradient>
        </defs>
        <path class="connection-path-1" d="" stroke="url(#line-gradient-1)" stroke-width="2" fill="none" stroke-dasharray="8 4" />
        <path class="connection-path-2" d="" stroke="url(#line-gradient-2)" stroke-width="2" fill="none" stroke-dasharray="8 4" />
      </svg>

      <!-- Cards Grid -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 lg:gap-6 relative z-10">
        {items.map((item, index) => {
          const iconPath = iconPaths[item.icon] || iconPaths.database;

          return (
            <a
              href={`/${lang}/case-studies/${item.caseSlug}`}
              class={`hired-card group relative reveal-element opacity-0 translate-y-12`}
              style={`transition-delay: ${index * 200}ms; --card-color: ${item.color};`}
              data-card-index={index}
            >
              <!-- Card glow effect -->
              <div class="absolute -inset-1 rounded-3xl bg-gradient-to-r opacity-0 group-hover:opacity-100 blur-xl transition-all duration-700"
                   style={`background: linear-gradient(135deg, ${item.color}40, transparent 50%, ${item.color}20);`}></div>

              <!-- Main card -->
              <div class="card-inner relative bg-surface/80 backdrop-blur-xl rounded-2xl border border-white/10 overflow-hidden h-full transition-all duration-500 group-hover:border-white/20">
                <!-- Top gradient bar -->
                <div class="h-1 w-full bg-gradient-to-r" style={`background: linear-gradient(90deg, ${item.color}, ${item.color}80);`}></div>

                <!-- Card header with icon -->
                <div class="p-6 pb-4">
                  <!-- Number badge and icon row -->
                  <div class="flex items-center justify-between mb-6">
                    <!-- Number badge -->
                    <div class="relative">
                      <span class="text-6xl font-black bg-gradient-to-br from-foreground/10 to-transparent bg-clip-text text-transparent">
                        {String(index + 1).padStart(2, '0')}
                      </span>
                      <span class="absolute top-0 left-0 text-6xl font-black opacity-0 group-hover:opacity-100 transition-opacity duration-500"
                            style={`color: ${item.color}30;`}>
                        {String(index + 1).padStart(2, '0')}
                      </span>
                    </div>

                    <!-- Animated icon container -->
                    <div class="icon-container relative">
                      <!-- Rotating ring -->
                      <svg class="absolute -inset-2 w-16 h-16 opacity-0 group-hover:opacity-100 transition-all duration-500" viewBox="0 0 64 64">
                        <circle
                          cx="32" cy="32" r="28"
                          fill="none"
                          stroke={item.color}
                          stroke-width="1"
                          stroke-dasharray="4 4"
                          class="animate-spin-slow"
                          style="animation-duration: 20s;"
                        />
                      </svg>

                      <!-- Icon background glow -->
                      <div class="absolute inset-0 rounded-xl blur-md opacity-0 group-hover:opacity-60 transition-all duration-500"
                           style={`background: ${item.color};`}></div>

                      <!-- Icon box -->
                      <div class="relative w-12 h-12 rounded-xl flex items-center justify-center transition-all duration-500 group-hover:scale-110"
                           style={`background: linear-gradient(135deg, ${item.color}20, ${item.color}10);`}>
                        <svg class="w-6 h-6 transition-all duration-500 group-hover:scale-110" viewBox="0 0 24 24" fill={item.color}>
                          <path d={iconPath}/>
                        </svg>
                      </div>
                    </div>
                  </div>

                  <!-- Title -->
                  <h3 class="text-xl font-bold text-foreground mb-3 group-hover:text-accent transition-colors duration-300">
                    {t(lang, `hiredFor.bullets.${item.key}`)}
                  </h3>

                  <!-- Metric showcase -->
                  <div class="metric-box relative p-4 rounded-xl bg-gradient-to-br from-background/80 to-background/40 border border-white/5 mb-4 overflow-hidden">
                    <!-- Shimmer effect -->
                    <div class="absolute inset-0 shimmer-effect opacity-0 group-hover:opacity-100"></div>

                    <div class="relative flex items-baseline gap-2">
                      <span class="metric-value text-3xl md:text-4xl font-black transition-all duration-500"
                            style={`color: ${item.color};`}
                            data-metric={item.metric}>
                        {item.metric}
                      </span>
                      <span class="text-sm text-muted">
                        {getStr(item.metricLabel)}
                      </span>
                    </div>
                  </div>

                  <!-- Highlights list -->
                  <ul class="space-y-2 mb-4">
                    {item.highlights.map((highlight, hIndex) => (
                      <li class="flex items-center gap-2 text-sm text-muted/80 group-hover:text-muted transition-colors duration-300"
                          style={`transition-delay: ${hIndex * 50}ms;`}>
                        <svg class="w-4 h-4 flex-shrink-0" viewBox="0 0 20 20" fill={item.color}>
                          <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                        </svg>
                        <span>{getStr(highlight)}</span>
                      </li>
                    ))}
                  </ul>
                </div>

                <!-- Card footer with tools -->
                <div class="px-6 pb-6 pt-2 border-t border-white/5">
                  <div class="flex items-center justify-between">
                    <!-- Tools tags -->
                    <div class="flex flex-wrap gap-1.5">
                      {item.tools.map((tool) => (
                        <span class="px-2 py-0.5 text-xs rounded-full bg-white/5 text-muted/70 group-hover:bg-white/10 group-hover:text-muted transition-all duration-300">
                          {tool}
                        </span>
                      ))}
                    </div>

                    <!-- Arrow indicator -->
                    <div class="flex items-center gap-1 text-sm font-medium opacity-0 group-hover:opacity-100 transition-all duration-300 translate-x-2 group-hover:translate-x-0"
                         style={`color: ${item.color};`}>
                      <span class="hidden sm:inline">
                        {lang === 'es' ? 'Ver caso' : lang === 'fr' ? 'Voir cas' : lang === 'pt' ? 'Ver caso' : 'View case'}
                      </span>
                      <svg class="w-5 h-5 transition-transform duration-300 group-hover:translate-x-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M5 12h14M12 5l7 7-7 7"/>
                      </svg>
                    </div>
                  </div>
                </div>

                <!-- Hover overlay gradient -->
                <div class="absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-500 pointer-events-none"
                     style={`background: linear-gradient(135deg, ${item.color}05, transparent 50%, ${item.color}03);`}></div>
              </div>
            </a>
          );
        })}
      </div>
    </div>

    <!-- Bottom CTA section -->
    <div class="mt-20 text-center reveal-element opacity-0 translate-y-8" style="transition-delay: 800ms;">
      <div class="inline-flex flex-col sm:flex-row items-center gap-4">
        <a href={`/${lang}/case-studies`}
           class="group inline-flex items-center gap-3 px-8 py-4 rounded-full bg-gradient-to-r from-accent to-accent/80 text-background font-semibold transition-all duration-300 hover:shadow-lg hover:shadow-accent/25 hover:scale-105">
          <span>
            {lang === 'es' ? 'Explorar Todos los Casos' : lang === 'fr' ? 'Explorer Tous les Cas' : lang === 'pt' ? 'Explorar Todos os Casos' : 'Explore All Cases'}
          </span>
          <svg class="w-5 h-5 transition-transform duration-300 group-hover:translate-x-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M5 12h14M12 5l7 7-7 7"/>
          </svg>
        </a>

        <span class="text-muted/50">
          {lang === 'es' ? 'o' : lang === 'fr' ? 'ou' : lang === 'pt' ? 'ou' : 'or'}
        </span>

        <a href={`/${lang}/resume`}
           class="group inline-flex items-center gap-2 px-6 py-3 rounded-full border border-white/10 hover:border-accent/30 text-muted hover:text-foreground transition-all duration-300">
          <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
            <path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/>
          </svg>
          <span>
            {lang === 'es' ? 'Ver Curriculum' : lang === 'fr' ? 'Voir CV' : lang === 'pt' ? 'Ver Currículo' : 'View Resume'}
          </span>
        </a>
      </div>
    </div>
  </div>
</section>

<style>
  /* Orb animations */
  .orb-1 {
    animation: orb-float-1 20s ease-in-out infinite;
  }
  .orb-2 {
    animation: orb-float-2 25s ease-in-out infinite;
  }
  .orb-3 {
    animation: orb-float-3 22s ease-in-out infinite;
  }

  @keyframes orb-float-1 {
    0%, 100% { transform: translate(0, 0) scale(1); }
    25% { transform: translate(5%, 10%) scale(1.1); }
    50% { transform: translate(10%, 5%) scale(1); }
    75% { transform: translate(3%, -5%) scale(0.95); }
  }

  @keyframes orb-float-2 {
    0%, 100% { transform: translate(0, 0) scale(1); }
    33% { transform: translate(-8%, -5%) scale(1.05); }
    66% { transform: translate(5%, 8%) scale(0.95); }
  }

  @keyframes orb-float-3 {
    0%, 100% { transform: translate(0, 0) scale(1); }
    50% { transform: translate(-10%, -10%) scale(1.1); }
  }

  /* Particle animation */
  @keyframes float-particle {
    0%, 100% {
      transform: translateY(0) translateX(0) scale(1);
      opacity: 0.4;
    }
    25% {
      transform: translateY(-20px) translateX(10px) scale(1.2);
      opacity: 0.6;
    }
    50% {
      transform: translateY(-10px) translateX(-5px) scale(0.8);
      opacity: 0.3;
    }
    75% {
      transform: translateY(-30px) translateX(15px) scale(1.1);
      opacity: 0.5;
    }
  }

  /* Card 3D effects */
  .hired-card {
    transform-style: preserve-3d;
    transition: transform 0.6s cubic-bezier(0.23, 1, 0.32, 1);
  }

  .hired-card:hover {
    transform: translateY(-8px) rotateX(2deg) rotateY(-2deg);
  }

  .hired-card:hover .card-inner {
    box-shadow:
      0 25px 50px -12px rgba(0, 0, 0, 0.25),
      0 0 0 1px rgba(255, 255, 255, 0.1),
      inset 0 1px 0 rgba(255, 255, 255, 0.1);
  }

  /* Shimmer effect */
  .shimmer-effect {
    background: linear-gradient(
      90deg,
      transparent 0%,
      rgba(255, 255, 255, 0.05) 50%,
      transparent 100%
    );
    animation: shimmer 2s infinite;
  }

  @keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
  }

  /* Slow spin for ring */
  .animate-spin-slow {
    animation: spin 20s linear infinite;
  }

  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  /* Connection line animation */
  .connection-path-1,
  .connection-path-2 {
    stroke-dashoffset: 0;
    animation: dash-flow 30s linear infinite;
  }

  @keyframes dash-flow {
    to {
      stroke-dashoffset: -100;
    }
  }

  /* Metric value animation */
  .metric-value {
    font-variant-numeric: tabular-nums;
  }

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .orb-1, .orb-2, .orb-3,
    .particle,
    .shimmer-effect,
    .animate-spin-slow,
    .connection-path-1,
    .connection-path-2 {
      animation: none;
    }

    .hired-card:hover {
      transform: translateY(-4px);
    }
  }
</style>

<script>
  import { initOnce } from '@/lib/lifecycle';
  import { animateCounter, bindTilt, createRevealObserver } from '@/lib/ui/animations';

  function parseMetric(metric: string) {
    const prefix = metric.startsWith('$') ? '$' : '';
    let suffix = '';
    if (metric.includes('K')) suffix += 'K';
    if (metric.includes('%')) suffix += '%';
    if (metric.includes('+')) suffix += '+';
    const numericPart = metric.replace(/[^0-9]/g, '');
    const target = parseInt(numericPart, 10) || 0;
    return { prefix, suffix, target };
  }

  function initHiredFor() {
    const section = document.getElementById('hired-for');
    initOnce(section, 'hired-for', (root) => {
      const cleanups: Array<() => void> = [];
      const timeouts: number[] = [];

      const revealCleanup = createRevealObserver(root, {
        selector: '.reveal-element',
        threshold: 0.4,
        rootMargin: '-50px 0px -50px 0px',
        visibleClass: '',
        onReveal: (el) => {
          el.classList.remove('opacity-0', 'translate-y-8', 'translate-y-12');
          el.classList.add('opacity-100', 'translate-y-0');

          if (el.classList.contains('hired-card')) {
            const metricEl = el.querySelector('.metric-value') as HTMLElement | null;
            if (metricEl) {
              const metric = metricEl.dataset.metric || metricEl.textContent || '';
              const { prefix, suffix, target } = parseMetric(metric);
              if (!target) {
                metricEl.textContent = metric;
              } else {
                const timeoutId = window.setTimeout(() => {
                  cleanups.push(
                    animateCounter(metricEl, {
                      target,
                      duration: 1500,
                      easing: 'easeOutExpo',
                      prefix,
                      suffix,
                    })
                  );
                }, 400);
                timeouts.push(timeoutId);
              }
            }
          }
        },
      });

      updateConnectionLines();
      const resizeHandler = () => updateConnectionLines();
      window.addEventListener('resize', resizeHandler);

      root.querySelectorAll('.hired-card').forEach((card) => {
        cleanups.push(
          bindTilt(card as HTMLElement, {
            intensity: 20,
            scale: 1.02,
            perspective: 1200,
            onLeave: () => {
              (card as HTMLElement).style.transform = '';
            },
          })
        );
      });

      return () => {
        revealCleanup();
        timeouts.forEach((timeoutId) => window.clearTimeout(timeoutId));
        cleanups.forEach((cleanup) => cleanup());
        window.removeEventListener('resize', resizeHandler);
      };
    });
  }

  function updateConnectionLines() {
    const svg = document.querySelector('.connection-lines');
    if (!svg || window.innerWidth < 1024) return;

    const cards = document.querySelectorAll('.hired-card');
    if (cards.length < 3) return;

    const path1 = svg.querySelector('.connection-path-1');
    const path2 = svg.querySelector('.connection-path-2');

    const svgRect = svg.getBoundingClientRect();

    const getCardCenter = (card: Element) => {
      const rect = card.getBoundingClientRect();
      return {
        x: rect.left + rect.width / 2 - svgRect.left,
        y: rect.top + rect.height / 2 - svgRect.top
      };
    };

    const card1 = getCardCenter(cards[0]);
    const card2 = getCardCenter(cards[1]);
    const card3 = getCardCenter(cards[2]);

    // Curved paths between cards
    const curve1 = `M ${card1.x} ${card1.y} Q ${(card1.x + card2.x) / 2} ${card1.y - 50} ${card2.x} ${card2.y}`;
    const curve2 = `M ${card2.x} ${card2.y} Q ${(card2.x + card3.x) / 2} ${card2.y - 50} ${card3.x} ${card3.y}`;

    if (path1) path1.setAttribute('d', curve1);
    if (path2) path2.setAttribute('d', curve2);
  }

  initHiredFor();
  document.addEventListener('astro:page-load', initHiredFor);
</script>
