---
import { t } from '@/i18n';
import type { Lang } from '@/i18n/config';

interface Node {
  id: string;
  label: Record<string, string>;
  icon: string;
  color: string;
  description: Record<string, string>;
  items: string[];
}

interface Edge {
  from: string;
  to: string;
  curve?: boolean;
  label?: Record<string, string>;
}

interface Props {
  lang: Lang;
  model: {
    nodes: Node[];
    edges: Edge[];
  };
}

const { lang, model } = Astro.props;
const { nodes, edges } = model;

const getStr = (obj: any) => (typeof obj === 'string' ? obj : obj[lang] || obj.en);

// Icon SVG paths
const iconPaths: Record<string, string> = {
  database: 'M12 2C6.48 2 2 4.69 2 8v8c0 3.31 4.48 6 10 6s10-2.69 10-6V8c0-3.31-4.48-6-10-6z',
  cog: 'M12 15a3 3 0 100-6 3 3 0 000 6z M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z',
  chart: 'M18 20V10M12 20V4M6 20v-6',
  target: 'M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z M12 18a6 6 0 100-12 6 6 0 000 12z M12 14a2 2 0 100-4 2 2 0 000 4z'
};

---

<section class="relative py-24 md:py-32 overflow-hidden" id="operating-model">
  <!-- Animated Background -->
  <div class="absolute inset-0 pointer-events-none">
    <div class="absolute inset-0 bg-gradient-to-b from-background via-background-alt/30 to-background"></div>

    <!-- Animated grid -->
    <svg class="absolute inset-0 w-full h-full opacity-[0.03]" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <pattern id="op-grid" width="60" height="60" patternUnits="userSpaceOnUse">
          <path d="M 60 0 L 0 0 0 60" fill="none" stroke="currentColor" stroke-width="1"/>
        </pattern>
      </defs>
      <rect width="100%" height="100%" fill="url(#op-grid)" />
    </svg>

    <!-- Floating orbs -->
    <div class="op-orb-1 absolute w-[400px] h-[400px] rounded-full blur-3xl opacity-20"
         style="background: radial-gradient(circle, #6ee7b7 0%, transparent 70%); top: 10%; left: 5%;"></div>
    <div class="op-orb-2 absolute w-[350px] h-[350px] rounded-full blur-3xl opacity-15"
         style="background: radial-gradient(circle, #c4b5fd 0%, transparent 70%); bottom: 10%; right: 10%;"></div>

    <!-- Particles -->
    {Array.from({ length: 20 }).map((_, i) => (
      <div
        class="absolute w-1 h-1 rounded-full bg-accent/30 op-particle"
        style={`
          left: ${10 + (i * 4) % 80}%;
          top: ${15 + (i * 7) % 70}%;
          animation: op-float ${6 + (i % 4)}s ease-in-out infinite;
          animation-delay: ${(i % 3) * 1}s;
        `}
      />
    ))}
  </div>

  <div class="container relative z-10">
    <!-- Header -->
    <div class="text-center mb-16 op-reveal">
      <div class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-accent/10 border border-accent/20 mb-6">
        <svg class="w-4 h-4 text-accent" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
        </svg>
        <span class="text-sm font-medium text-accent">
          {lang === 'es' ? 'Flujo de Trabajo' : lang === 'fr' ? 'Flux de Travail' : lang === 'pt' ? 'Fluxo de Trabalho' : 'Workflow'}
        </span>
      </div>

      <h2 class="text-4xl md:text-5xl font-bold text-foreground mb-4">
        {t(lang, 'operatingModel.title')}
      </h2>
      <p class="text-lg text-muted max-w-2xl mx-auto mb-2">
        {t(lang, 'operatingModel.lead')}
      </p>
      <p class="text-muted max-w-xl mx-auto">
        {t(lang, 'operatingModel.subtitle')}
      </p>
    </div>

    <!-- Flow Diagram Container -->
    <div class="relative max-w-6xl mx-auto">

      <!-- Desktop: Horizontal Flow with Cards -->
      <div class="hidden md:block">
        <div class="operating-diagram bg-surface/50 backdrop-blur-sm rounded-3xl border border-white/10 p-8 lg:p-12 op-reveal">

          <!-- Nodes Grid - Main Content -->
          <div class="grid grid-cols-4 gap-6 lg:gap-8 mb-8">
            {nodes.map((node, index) => {
              const iconPath = iconPaths[node.icon] || iconPaths.database;

              return (
                <div
                  class="node-card group relative"
                  data-node={node.id}
                  style={`--node-color: ${node.color};`}
                >
                  <!-- Glow effect -->
                  <div class="absolute -inset-2 rounded-2xl opacity-0 group-hover:opacity-100 blur-xl transition-all duration-500"
                       style={`background: ${node.color}30;`}></div>

                  <!-- Card content -->
                  <div class="relative bg-background/80 backdrop-blur-sm rounded-2xl border border-white/10 p-6 transition-all duration-500 group-hover:border-white/20 group-hover:-translate-y-2 min-h-[280px] flex flex-col">
                    <!-- Top accent -->
                    <div class="absolute top-0 left-4 right-4 h-0.5 rounded-full opacity-60"
                         style={`background: ${node.color};`}></div>

                    <!-- Step number -->
                    <div class="absolute -top-3 -right-3 w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold shadow-lg"
                         style={`background: ${node.color}; color: #1a1a2e;`}>
                      {index + 1}
                    </div>

                    <!-- Icon with ring -->
                    <div class="relative w-16 h-16 mx-auto mb-4 flex-shrink-0">
                      <!-- Rotating ring -->
                      <svg class="absolute inset-0 w-full h-full rotating-ring opacity-30" viewBox="0 0 64 64">
                        <circle cx="32" cy="32" r="30" fill="none" stroke={node.color} stroke-width="1" stroke-dasharray="4 4"/>
                      </svg>

                      <!-- Pulse ring on hover -->
                      <div class="absolute inset-0 rounded-full opacity-0 group-hover:opacity-40 transition-opacity duration-500"
                           style={`background: ${node.color}; filter: blur(8px);`}></div>

                      <!-- Icon container -->
                      <div class="absolute inset-2 rounded-xl flex items-center justify-center transition-transform duration-500 group-hover:scale-110"
                           style={`background: linear-gradient(135deg, ${node.color}30, ${node.color}10);`}>
                        <svg class="w-7 h-7" viewBox="0 0 24 24" fill="none" stroke={node.color} stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                          <path d={iconPath}/>
                        </svg>
                      </div>
                    </div>

                    <!-- Label -->
                    <h3 class="text-lg font-bold text-foreground text-center mb-2 group-hover:text-accent transition-colors">
                      {getStr(node.label)}
                    </h3>

                    <!-- Description -->
                    <p class="text-xs text-muted text-center mb-4 opacity-80 group-hover:opacity-100 transition-opacity flex-grow">
                      {getStr(node.description)}
                    </p>

                    <!-- Items tags -->
                    <div class="flex flex-wrap justify-center gap-1 mt-auto">
                      {node.items.map((item) => (
                        <span class="px-2 py-0.5 text-xs rounded-full transition-all duration-300"
                              style={`background: ${node.color}15; color: ${node.color};`}>
                          {item}
                        </span>
                      ))}
                    </div>
                  </div>
                </div>
              );
            })}
          </div>

          <!-- Connection arrows between cards -->
          <div class="flex items-center justify-center gap-4 mb-6">
            {nodes.slice(0, -1).map((node, index) => {
              const nextNode = nodes[index + 1];
              return (
                <div class="flex items-center gap-4" style={`flex: 1; max-width: 200px;`}>
                  <div class="flex-1 h-1 rounded-full relative overflow-hidden"
                       style={`background: linear-gradient(to right, ${node.color}40, ${nextNode.color}40);`}>
                    <!-- Animated flow -->
                    <div class="absolute inset-0 flow-animation"
                         style={`background: linear-gradient(to right, transparent, ${node.color}, ${nextNode.color}, transparent); animation-delay: ${index * 0.3}s;`}></div>
                  </div>
                  <svg class="w-4 h-4 flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke={nextNode.color} stroke-width="2">
                    <path d="M5 12h14M12 5l7 7-7 7"/>
                  </svg>
                </div>
              );
            })}
          </div>

          <!-- Learning Loop Label -->
          <div class="flex items-center justify-center gap-4 pt-4 border-t border-white/5">
            <div class="h-px flex-1 bg-gradient-to-r from-transparent via-accent/20 to-transparent"></div>
            <div class="flex items-center gap-2 px-4 py-2 rounded-full bg-background/80 border border-white/10 backdrop-blur-sm">
              <svg class="w-4 h-4 text-accent animate-spin-slow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 12a9 9 0 11-6.219-8.56"/>
              </svg>
              <span class="text-sm font-medium text-muted">
                {edges.find(e => e.curve)?.label ? getStr(edges.find(e => e.curve)?.label) : 'Learning Loop'}
              </span>
              <svg class="w-4 h-4 text-accent" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 3a2.828 2.828 0 114 4L7.5 20.5 2 22l1.5-5.5L17 3z"/>
              </svg>
            </div>
            <div class="h-px flex-1 bg-gradient-to-r from-transparent via-accent/20 to-transparent"></div>
          </div>
        </div>
      </div>

      <!-- Mobile: Vertical Flow -->
      <div class="md:hidden">
        <div class="space-y-6">
          {nodes.map((node, index) => {
            const iconPath = iconPaths[node.icon] || iconPaths.database;
            const isLast = index === nodes.length - 1;

            return (
              <div class="relative">
                <!-- Connector line to next card -->
                {!isLast && (
                  <div class="absolute left-6 top-full w-0.5 h-6 z-0"
                       style={`background: linear-gradient(to bottom, ${node.color}, ${nodes[index + 1]?.color || node.color});`}>
                    <!-- Arrow indicator -->
                    <svg class="absolute -bottom-1 left-1/2 -translate-x-1/2 w-3 h-3" viewBox="0 0 12 12" fill={nodes[index + 1]?.color || node.color}>
                      <path d="M6 12L0 6h12L6 12z"/>
                    </svg>
                  </div>
                )}

                <div class="mobile-node bg-surface/80 backdrop-blur-sm rounded-2xl border border-white/10 p-5 op-reveal"
                     style={`--node-color: ${node.color};`}>
                  <div class="flex items-start gap-4">
                    <!-- Icon -->
                    <div class="relative w-12 h-12 flex-shrink-0">
                      <div class="absolute inset-0 rounded-xl flex items-center justify-center"
                           style={`background: linear-gradient(135deg, ${node.color}30, ${node.color}10);`}>
                        <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke={node.color} stroke-width="1.5">
                          <path d={iconPath}/>
                        </svg>
                      </div>
                      <!-- Step number badge -->
                      <div class="absolute -top-2 -right-2 w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold shadow-lg"
                           style={`background: ${node.color}; color: #1a1a2e;`}>
                        {index + 1}
                      </div>
                    </div>

                    <!-- Content -->
                    <div class="flex-1 min-w-0">
                      <h3 class="font-bold text-foreground mb-1">{getStr(node.label)}</h3>
                      <p class="text-sm text-muted mb-3">{getStr(node.description)}</p>
                      <div class="flex flex-wrap gap-1">
                        {node.items.map((item) => (
                          <span class="px-2 py-0.5 text-xs rounded-full"
                                style={`background: ${node.color}20; color: ${node.color};`}>
                            {item}
                          </span>
                        ))}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            );
          })}

          <!-- Loop indicator -->
          <div class="flex items-center justify-center gap-2 py-4 mt-4">
            <div class="h-px flex-1 bg-gradient-to-r from-transparent via-accent/30 to-transparent"></div>
            <div class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-surface/80 border border-white/10">
              <svg class="w-4 h-4 text-accent animate-spin-slow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 12a9 9 0 11-6.219-8.56"/>
              </svg>
              <span class="text-xs text-muted">
                {edges.find(e => e.curve)?.label ? getStr(edges.find(e => e.curve)?.label) : 'Learning Loop'}
              </span>
            </div>
            <div class="h-px flex-1 bg-gradient-to-r from-transparent via-accent/30 to-transparent"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<style>
  /* Orb animations */
  .op-orb-1 {
    animation: op-orb-float-1 18s ease-in-out infinite;
  }
  .op-orb-2 {
    animation: op-orb-float-2 22s ease-in-out infinite;
  }

  @keyframes op-orb-float-1 {
    0%, 100% { transform: translate(0, 0) scale(1); }
    50% { transform: translate(5%, 10%) scale(1.1); }
  }

  @keyframes op-orb-float-2 {
    0%, 100% { transform: translate(0, 0) scale(1); }
    50% { transform: translate(-5%, -8%) scale(1.05); }
  }

  /* Particle float */
  @keyframes op-float {
    0%, 100% { transform: translateY(0) translateX(0); opacity: 0.3; }
    50% { transform: translateY(-15px) translateX(8px); opacity: 0.6; }
  }

  /* Rotating ring */
  .rotating-ring {
    animation: rotate-ring 20s linear infinite;
  }

  @keyframes rotate-ring {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  /* Slow spin for loop icon */
  .animate-spin-slow {
    animation: spin 3s linear infinite;
  }

  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  /* Flow animation for connection lines */
  .flow-animation {
    animation: flow-move 2s ease-in-out infinite;
  }

  @keyframes flow-move {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
  }

  /* Node card hover */
  .node-card {
    transition: all 0.5s cubic-bezier(0.23, 1, 0.32, 1);
  }

  /* Reveal animations */
  .op-reveal {
    opacity: 0;
    transform: translateY(20px);
    transition: opacity 0.8s ease, transform 0.8s ease;
  }

  .op-reveal.is-visible {
    opacity: 1;
    transform: translateY(0);
  }

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .op-orb-1, .op-orb-2, .op-particle, .rotating-ring, .animate-spin-slow, .flow-animation {
      animation: none;
    }

    .node-card:hover {
      transform: none;
    }

    .op-reveal {
      opacity: 1;
      transform: none;
    }
  }
</style>

<script>
  import { initOnce } from '@/lib/lifecycle';
  import { createRevealObserver } from '@/lib/ui/animations';

  function initOperatingModel() {
    const section = document.getElementById('operating-model');
    initOnce(section, 'operating-model', (root) => {
      const cleanupReveal = createRevealObserver(root, {
        selector: '.op-reveal',
        threshold: 0.1,
        rootMargin: '50px',
        visibleClass: 'is-visible',
      });

      return () => {
        cleanupReveal();
      };
    });
  }

  initOperatingModel();
  document.addEventListener('astro:page-load', initOperatingModel);
</script>
