---
/**
 * Education Section - EPIC EDITION
 * Features:
 * - Holographic/Iridescent cards with shimmer effect
 * - 3D Card flip with backside content
 * - Constellation particle network background
 * - Aurora borealis effect
 * - Orbital floating elements
 * - Magnetic cursor interaction
 * - Morphing blob backgrounds
 * - Neon glow with pulse
 * - Parallax depth layers
 * - Country flags with 3D rotation
 */

import { t } from '@/i18n';
import type { Lang } from '@/i18n/config';

interface EducationItem {
  id: string;
  status?: string;
  degree: { [key: string]: string } | string;
  field?: { [key: string]: string } | string;
  org: string;
  location: string;
  country?: string;
  year: string;
  icon: string;
  color: string;
  gradient: string;
  accentHue: number;
  highlights?: { [key: string]: string[] };
  skills?: string[];
  achievement?: { value: string; label: { [key: string]: string } };
  backContent?: { [key: string]: string } | string;
}

interface Props {
  lang: Lang;
  items: EducationItem[];
}

const { lang, items } = Astro.props;

const getStr = (obj: any) => (typeof obj === 'string' ? obj : obj?.[lang] || obj?.en || '');
const getArr = (obj: any): string[] => {
  if (Array.isArray(obj)) return obj;
  if (typeof obj === 'object' && obj !== null) return obj[lang] || obj.en || [];
  return [];
};

const countryFlags: Record<string, string> = {
  uk: 'ðŸ‡¬ðŸ‡§',
  fr: 'ðŸ‡«ðŸ‡·',
  co: 'ðŸ‡¨ðŸ‡´',
  us: 'ðŸ‡ºðŸ‡¸',
};

const countryNames: Record<string, Record<string, string>> = {
  uk: { en: 'United Kingdom', es: 'Reino Unido', fr: 'Royaume-Uni', pt: 'Reino Unido' },
  fr: { en: 'France', es: 'Francia', fr: 'France', pt: 'FranÃ§a' },
  co: { en: 'Colombia', es: 'Colombia', fr: 'Colombie', pt: 'ColÃ´mbia' },
};

const icons: Record<string, string> = {
  brain: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>`,
  globe: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>`,
  rocket: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15.59 14.37a6 6 0 01-5.84 7.38v-4.8m5.84-2.58a14.98 14.98 0 006.16-12.12A14.98 14.98 0 009.631 8.41m5.96 5.96a14.926 14.926 0 01-5.841 2.58m-.119-8.54a6 6 0 00-7.381 5.84h4.8m2.581-5.84a14.927 14.927 0 00-2.58 5.84m2.699 2.7c-.103.021-.207.041-.311.06a15.09 15.09 0 01-2.448-2.448 14.9 14.9 0 01.06-.312m-2.24 2.39a4.493 4.493 0 00-1.757 4.306 4.493 4.493 0 004.306-1.758M16.5 9a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z"/>`,
};
---

<section class="edu-section section relative overflow-hidden" id="education">
  <!-- Aurora Borealis Background -->
  <div class="edu-aurora absolute inset-0 pointer-events-none">
    <div class="edu-aurora-layer edu-aurora-1"></div>
    <div class="edu-aurora-layer edu-aurora-2"></div>
    <div class="edu-aurora-layer edu-aurora-3"></div>
  </div>

  <!-- Constellation Particle Canvas -->
  <canvas id="edu-constellation" class="absolute inset-0 pointer-events-none"></canvas>

  <!-- Floating Orbs (Parallax layers) -->
  <div class="edu-parallax-container absolute inset-0 pointer-events-none overflow-hidden">
    {items.map((item, i) => (
      <div
        class="edu-orb absolute rounded-full blur-3xl"
        style={`
          background: ${item.color};
          width: ${200 + i * 50}px;
          height: ${200 + i * 50}px;
          top: ${20 + i * 25}%;
          left: ${10 + i * 30}%;
          animation: edu-float ${8 + i * 2}s ease-in-out infinite;
          animation-delay: ${i * -2}s;
        `}
      />
    ))}
  </div>

  <!-- Morphing Blob -->
  <div class="edu-morph-blob absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[800px] h-[800px] pointer-events-none">
    <svg viewBox="0 0 200 200" class="w-full h-full">
      <defs>
        <linearGradient id="edu-blob-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" style="stop-color:#6ee7b7"/>
          <stop offset="50%" style="stop-color:#93c5fd"/>
          <stop offset="100%" style="stop-color:#c4b5fd"/>
        </linearGradient>
      </defs>
      <path class="edu-morph-path" fill="url(#edu-blob-gradient)">
        <animate
          attributeName="d"
          dur="20s"
          repeatCount="indefinite"
          values="
            M44.7,-76.4C58.8,-69.2,71.8,-59.1,79.6,-45.8C87.4,-32.5,90,-16.3,88.5,-0.9C87,14.5,81.4,29,73.1,41.8C64.8,54.6,53.8,65.7,40.7,73.1C27.6,80.5,12.3,84.2,-2.4,87.4C-17.1,90.6,-34.2,93.3,-47.8,86.4C-61.4,79.5,-71.5,63,-78.3,45.8C-85.1,28.6,-88.6,10.7,-87.1,-6.5C-85.6,-23.7,-79.1,-40.2,-68.4,-52.7C-57.7,-65.2,-42.8,-73.7,-27.7,-80.1C-12.6,-86.5,2.7,-90.8,17.8,-88.4C32.9,-86,47.8,-76.9,44.7,-76.4Z;
            M47.3,-79.9C62.1,-72.2,75.5,-61.2,82.8,-47.1C90.1,-33,91.3,-16.5,89.8,-0.9C88.3,14.7,84.1,29.4,76.1,42.1C68.1,54.8,56.3,65.5,42.8,73.2C29.3,80.9,14.6,85.6,-0.7,86.8C-16,88,-32,85.7,-45.5,78.5C-59,71.3,-70,59.2,-77.6,45.2C-85.2,31.2,-89.4,15.6,-89.1,0.2C-88.8,-15.2,-84,-30.4,-75.7,-43.2C-67.4,-56,-55.6,-66.4,-42.1,-74.7C-28.6,-83,-14.3,-89.2,0.8,-90.6C15.9,-92,31.8,-88.6,47.3,-79.9Z;
            M44.7,-76.4C58.8,-69.2,71.8,-59.1,79.6,-45.8C87.4,-32.5,90,-16.3,88.5,-0.9C87,14.5,81.4,29,73.1,41.8C64.8,54.6,53.8,65.7,40.7,73.1C27.6,80.5,12.3,84.2,-2.4,87.4C-17.1,90.6,-34.2,93.3,-47.8,86.4C-61.4,79.5,-71.5,63,-78.3,45.8C-85.1,28.6,-88.6,10.7,-87.1,-6.5C-85.6,-23.7,-79.1,-40.2,-68.4,-52.7C-57.7,-65.2,-42.8,-73.7,-27.7,-80.1C-12.6,-86.5,2.7,-90.8,17.8,-88.4C32.9,-86,47.8,-76.9,44.7,-76.4Z
          "
        />
      </path>
    </svg>
  </div>

  <div class="container relative z-10">
    <!-- Epic Header with Glitch Effect -->
    <div class="edu-header text-center mb-16 edu-reveal">
      <div class="inline-flex items-center gap-3 px-6 py-3 rounded-full edu-badge backdrop-blur-xl mb-8">
        <span class="edu-globe-spin text-3xl">ðŸŽ“</span>
        <span class="text-sm font-medium edu-badge-text tracking-widest uppercase">
          {t(lang, 'education.subtitle') || 'Academic Journey'}
        </span>
      </div>

      <h2 class="edu-title-glitch text-4xl md:text-6xl font-black edu-title mb-6" data-text={t(lang, 'education.title')}>
        {t(lang, 'education.title')}
      </h2>

      <p class="edu-subtitle text-lg md:text-xl edu-subtitle-text max-w-2xl mx-auto">
        Three countries. Three degrees. One global perspective.
      </p>

      <!-- World Map Path -->
      <div class="edu-world-path mt-10 flex items-center justify-center gap-4 md:gap-8">
        {items.map((item, i) => (
          <Fragment>
            <div
              class="edu-country-node group relative"
              style={`--accent: ${item.color}; animation-delay: ${i * 0.3}s`}
            >
              <div class="edu-country-flag text-4xl md:text-5xl transform transition-transform group-hover:scale-125 group-hover:-rotate-12 cursor-pointer">
                {countryFlags[item.country || 'uk']}
              </div>
              <div class="absolute -bottom-8 left-1/2 -translate-x-1/2 opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">
                <span class="text-xs font-medium px-2 py-1 rounded-full" style={`background: ${item.color}20; color: ${item.color}`}>
                  {countryNames[item.country || 'uk'][lang]}
                </span>
              </div>
              <!-- Pulse ring -->
              <div class="edu-pulse-ring absolute inset-0 rounded-full border-2 opacity-0" style={`border-color: ${item.color}`}></div>
            </div>
            {i < items.length - 1 && (
              <div class="edu-path-line flex-1 max-w-24 h-0.5 relative overflow-hidden rounded-full edu-path-bg">
                <div
                  class="edu-path-flow absolute inset-0 rounded-full"
                  style={`background: linear-gradient(90deg, ${items[i].color}, ${items[i+1].color}); animation-delay: ${i * 0.5}s`}
                />
              </div>
            )}
          </Fragment>
        ))}
      </div>
    </div>

    <!-- 3D Flip Cards Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 lg:gap-10">
      {items.map((item, index) => {
        const highlights = getArr(item.highlights);
        const skills = item.skills || [];
        const backContent = getStr(item.backContent);
        const achievementLabel = item.achievement ? getStr(item.achievement.label) : '';

        return (
          <div
            class="edu-card-wrapper perspective-1000 edu-reveal"
            style={`--card-index: ${index}; --accent: ${item.color}; --accent-hue: ${item.accentHue}`}
          >
            <div class="edu-card relative w-full aspect-[3/4] cursor-pointer transform-style-3d transition-transform duration-700">

              <!-- Front Side -->
              <div class="edu-card-front absolute inset-0 backface-hidden rounded-3xl overflow-hidden">
                <!-- Holographic Shimmer Layer -->
                <div class="edu-holographic absolute inset-0 pointer-events-none"></div>

                <!-- Glassmorphism Background -->
                <div class="absolute inset-0 edu-card-glass backdrop-blur-2xl"></div>

                <!-- Gradient Border -->
                <div class={`absolute inset-0 rounded-3xl p-[1px] bg-gradient-to-br ${item.gradient}`}>
                  <div class="absolute inset-[1px] rounded-3xl edu-card-bg"></div>
                </div>

                <!-- Spotlight Effect -->
                <div class="edu-spotlight absolute inset-0 pointer-events-none opacity-0 transition-opacity rounded-3xl"></div>

                <!-- Content -->
                <div class="relative h-full p-6 md:p-8 flex flex-col z-10">
                  <!-- Top: Status & Year -->
                  <div class="flex items-start justify-between mb-6">
                    {item.status === 'inProgress' ? (
                      <div class="edu-status-badge inline-flex items-center gap-2 px-3 py-1.5 rounded-full edu-status-bg backdrop-blur-xl">
                        <span class="edu-status-dot relative flex h-2.5 w-2.5">
                          <span class="animate-ping absolute inline-flex h-full w-full rounded-full opacity-75" style={`background: ${item.color}`}></span>
                          <span class="relative inline-flex rounded-full h-2.5 w-2.5" style={`background: ${item.color}`}></span>
                        </span>
                        <span class="text-xs font-semibold edu-card-text-secondary">{t(lang, 'education.inProgress')}</span>
                      </div>
                    ) : (
                      <div class="edu-year-badge px-4 py-2 rounded-xl edu-year-bg backdrop-blur-xl">
                        <span class="text-lg font-bold" style={`color: ${item.color}`}>{item.year}</span>
                      </div>
                    )}

                    <!-- Country Flag with 3D Rotate -->
                    <div class="edu-flag-3d text-4xl transform-gpu transition-transform hover:scale-110" style="transform-style: preserve-3d">
                      {countryFlags[item.country || 'uk']}
                    </div>
                  </div>

                  <!-- Icon with Orbital Ring -->
                  <div class="relative w-20 h-20 mx-auto mb-6">
                    <div class="edu-orbital absolute inset-0">
                      <div class="edu-orbit-ring absolute inset-0 rounded-full border border-dashed" style={`border-color: ${item.color}40`}></div>
                      <div class="edu-orbit-dot absolute w-2 h-2 rounded-full" style={`background: ${item.color}`}></div>
                    </div>
                    <div class="absolute inset-0 flex items-center justify-center">
                      <div class={`edu-icon-glow absolute inset-2 rounded-2xl bg-gradient-to-br ${item.gradient} blur-xl opacity-50`}></div>
                      <div class={`relative w-16 h-16 rounded-2xl bg-gradient-to-br ${item.gradient} p-0.5`}>
                        <div class="w-full h-full rounded-2xl edu-icon-bg flex items-center justify-center">
                          <svg class="w-8 h-8 edu-icon-color" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <Fragment set:html={icons[item.icon] || icons.brain} />
                          </svg>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Degree Info -->
                  <div class="text-center flex-1 flex flex-col">
                    <h3 class="text-xl md:text-2xl font-bold edu-card-text mb-2 leading-tight">
                      {getStr(item.degree)}
                    </h3>

                    {item.field && (
                      <p class="text-sm font-medium mb-4" style={`color: ${item.color}`}>
                        {getStr(item.field)}
                      </p>
                    )}

                    <div class="flex items-center justify-center gap-2 edu-card-text-muted text-sm mb-4">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                      </svg>
                      <span class="font-medium">{item.org}</span>
                    </div>

                    <!-- Achievement Badge -->
                    {item.achievement && (
                      <div class="edu-achievement mt-auto mb-4">
                        <div class="inline-flex items-center gap-2 px-4 py-2 rounded-full" style={`background: ${item.color}15`}>
                          <span class="text-2xl font-black" style={`color: ${item.color}`}>{item.achievement.value}</span>
                          <span class="text-xs edu-card-text-muted">{achievementLabel}</span>
                        </div>
                      </div>
                    )}

                    <!-- Skills Pills -->
                    <div class="flex flex-wrap justify-center gap-2 mt-auto">
                      {skills.slice(0, 4).map((skill, si) => (
                        <span
                          class="edu-skill-pill px-3 py-1 text-xs font-medium rounded-full edu-pill-bg edu-card-text-secondary transition-all"
                          style={`animation-delay: ${si * 0.1}s`}
                        >
                          {skill}
                        </span>
                      ))}
                    </div>
                  </div>

                  <!-- Flip Hint -->
                  <div class="edu-flip-hint absolute bottom-4 right-4 flex items-center gap-1 text-xs edu-card-text-muted">
                    <span>Flip</span>
                    <svg class="w-4 h-4 edu-flip-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                  </div>
                </div>

                <!-- Noise Texture Overlay -->
                <div class="absolute inset-0 opacity-[0.03] pointer-events-none rounded-3xl" style="background-image: url('data:image/svg+xml,%3Csvg%20viewBox%3D%220%200%20200%20200%22%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%3E%3Cfilter%20id%3D%22noise%22%3E%3CfeTurbulence%20type%3D%22fractalNoise%22%20baseFrequency%3D%220.65%22%20numOctaves%3D%223%22%20stitchTiles%3D%22stitch%22/%3E%3C/filter%3E%3Crect%20width%3D%22100%25%22%20height%3D%22100%25%22%20filter%3D%22url(%23noise)%22/%3E%3C/svg%3E')"></div>
              </div>

              <!-- Back Side -->
              <div class="edu-card-back absolute inset-0 backface-hidden rounded-3xl overflow-hidden rotate-y-180">
                <!-- Glassmorphism Background -->
                <div class="absolute inset-0 edu-card-glass backdrop-blur-2xl"></div>

                <!-- Gradient Border -->
                <div class={`absolute inset-0 rounded-3xl p-[1px] bg-gradient-to-br ${item.gradient}`}>
                  <div class="absolute inset-[1px] rounded-3xl edu-card-bg-back"></div>
                </div>

                <!-- Back Content -->
                <div class="relative h-full p-6 md:p-8 flex flex-col z-10">
                  <div class="flex items-center gap-3 mb-6">
                    <div class={`w-10 h-10 rounded-xl bg-gradient-to-br ${item.gradient} p-0.5`}>
                      <div class="w-full h-full rounded-xl edu-icon-bg flex items-center justify-center">
                        <svg class="w-5 h-5 edu-icon-color" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <Fragment set:html={icons[item.icon] || icons.brain} />
                        </svg>
                      </div>
                    </div>
                    <div>
                      <h4 class="text-lg font-bold edu-card-text">{item.org}</h4>
                      <p class="text-xs edu-card-text-muted">{item.location}</p>
                    </div>
                  </div>

                  <p class="edu-card-text-secondary text-sm leading-relaxed mb-6 flex-1">
                    {backContent}
                  </p>

                  <!-- Highlights -->
                  <div class="space-y-3 mb-6">
                    <h5 class="text-xs font-semibold edu-card-text-muted uppercase tracking-wider">Key Focus Areas</h5>
                    {highlights.map((h, hi) => (
                      <div class="flex items-center gap-3 text-sm edu-card-text-secondary">
                        <div class="edu-check-icon w-5 h-5 rounded-full flex items-center justify-center" style={`background: ${item.color}20`}>
                          <svg class="w-3 h-3" style={`color: ${item.color}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/>
                          </svg>
                        </div>
                        <span>{h}</span>
                      </div>
                    ))}
                  </div>

                  <!-- Progress bar for in-progress -->
                  {item.status === 'inProgress' && item.achievement && (
                    <div class="mt-auto">
                      <div class="flex items-center justify-between text-xs edu-card-text-muted mb-2">
                        <span>Progress</span>
                        <span>Expected 2026</span>
                      </div>
                      <div class="h-2 edu-progress-track rounded-full overflow-hidden">
                        <div
                          class="edu-progress-bar h-full rounded-full transition-all duration-1000"
                          style={`width: 0%; background: linear-gradient(90deg, ${item.color}, ${item.color}80)`}
                          data-width="35"
                        ></div>
                      </div>
                    </div>
                  )}

                  <!-- Flip Back Hint -->
                  <div class="edu-flip-hint absolute bottom-4 right-4 flex items-center gap-1 text-xs edu-card-text-muted">
                    <span>Back</span>
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"/>
                    </svg>
                  </div>
                </div>
              </div>
            </div>
          </div>
        );
      })}
    </div>

    <!-- Bottom Stats Banner -->
    <div class="edu-stats-banner mt-12 edu-reveal">
      <div class="relative py-8 px-6 rounded-3xl overflow-hidden">
        <!-- Holographic Background -->
        <div class="edu-banner-holo absolute inset-0"></div>
        <div class="absolute inset-0 edu-banner-bg backdrop-blur-xl"></div>

        <div class="relative z-10 grid grid-cols-3 gap-8 text-center">
          <div class="edu-stat-item">
            <div class="edu-stat-value text-4xl md:text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-emerald-400 to-teal-400">3</div>
            <div class="text-sm edu-card-text-muted mt-1">{lang === 'es' ? 'PaÃ­ses' : lang === 'fr' ? 'Pays' : lang === 'pt' ? 'PaÃ­ses' : 'Countries'}</div>
          </div>
          <div class="edu-stat-item">
            <div class="edu-stat-value text-4xl md:text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-indigo-400">2</div>
            <div class="text-sm edu-card-text-muted mt-1">{lang === 'es' ? 'MaestrÃ­as' : lang === 'fr' ? 'Masters' : lang === 'pt' ? 'Mestrados' : "Master's"}</div>
          </div>
          <div class="edu-stat-item">
            <div class="edu-stat-value text-4xl md:text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-violet-400 to-purple-400">10+</div>
            <div class="text-sm edu-card-text-muted mt-1">{lang === 'es' ? 'AÃ±os de Estudio' : lang === 'fr' ? 'AnnÃ©es d\'Ã‰tudes' : lang === 'pt' ? 'Anos de Estudo' : 'Years of Study'}</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  import { initOnce } from '@/lib/lifecycle';

  function initEducation() {
    const section = document.getElementById('education');
    initOnce(section, 'education', (root) => {
      const disposers: Array<() => void> = [];
      const intervals: number[] = [];
      const on = (
        target: EventTarget,
        event: string,
        handler: EventListenerOrEventListenerObject,
        options?: AddEventListenerOptions
      ) => {
        target.addEventListener(event, handler, options);
        disposers.push(() => target.removeEventListener(event, handler, options));
      };

      let animationId: number | null = null;
      let observer: IntersectionObserver | null = null;
      let statsObserver: IntersectionObserver | null = null;

      // === CONSTELLATION PARTICLE NETWORK ===
      const canvas = root.querySelector('#edu-constellation') as HTMLCanvasElement | null;
      if (canvas) {
        const ctx = canvas.getContext('2d');
        if (ctx) {
          let particles: Array<{x: number; y: number; vx: number; vy: number; size: number; hue: number}> = [];
          const mouse = { x: 0, y: 0, active: false };
          const container = canvas.parentElement ?? root;

          const resize = () => {
            const rect = container.getBoundingClientRect();
            canvas.width = rect.width;
            canvas.height = rect.height;
          };

          const createParticles = () => {
            particles = [];
            const count = Math.min(80, Math.floor((canvas.width * canvas.height) / 15000));
            for (let i = 0; i < count; i++) {
              particles.push({
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height,
                vx: (Math.random() - 0.5) * 0.5,
                vy: (Math.random() - 0.5) * 0.5,
                size: Math.random() * 2 + 1,
                hue: [160, 220, 280][Math.floor(Math.random() * 3)]
              });
            }
          };

          const animate = () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const isDark = document.documentElement.classList.contains('dark');
            const baseOpacity = isDark ? 0.6 : 0.4;
            const lineOpacity = isDark ? 0.3 : 0.15;

            particles.forEach((p, i) => {
              if (mouse.active) {
                const dx = mouse.x - p.x;
                const dy = mouse.y - p.y;
                const dist = Math.sqrt(dx * dx + dy * dy);
                if (dist < 200) {
                  p.vx += dx * 0.00005;
                  p.vy += dy * 0.00005;
                }
              }

              p.x += p.vx;
              p.y += p.vy;

              if (p.x < 0 || p.x > canvas.width) p.vx *= -1;
              if (p.y < 0 || p.y > canvas.height) p.vy *= -1;

              ctx.beginPath();
              ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
              ctx.fillStyle = `hsla(${p.hue}, ${isDark ? 70 : 60}%, ${isDark ? 60 : 45}%, ${baseOpacity})`;
              ctx.fill();

              particles.slice(i + 1).forEach((p2) => {
                const dx = p.x - p2.x;
                const dy = p.y - p2.y;
                const dist = Math.sqrt(dx * dx + dy * dy);
                if (dist < 120) {
                  ctx.beginPath();
                  ctx.moveTo(p.x, p.y);
                  ctx.lineTo(p2.x, p2.y);
                  const alpha = (1 - dist / 120) * lineOpacity;
                  ctx.strokeStyle = `hsla(${(p.hue + p2.hue) / 2}, ${isDark ? 60 : 50}%, ${isDark ? 50 : 40}%, ${alpha})`;
                  ctx.lineWidth = 0.5;
                  ctx.stroke();
                }
              });
            });

            animationId = requestAnimationFrame(animate);
          };

          resize();
          createParticles();
          animate();

          const handleResize = () => {
            resize();
            createParticles();
          };
          on(window, 'resize', handleResize);

          on(container, 'mousemove', (e) => {
            const mouseEvent = e as MouseEvent;
            const rect = canvas.getBoundingClientRect();
            mouse.x = mouseEvent.clientX - rect.left;
            mouse.y = mouseEvent.clientY - rect.top;
            mouse.active = true;
          });

          on(container, 'mouseleave', () => {
            mouse.active = false;
          });
        }
      }

      // === 3D CARD FLIP ===
      root.querySelectorAll('.edu-card').forEach((card) => {
        let isFlipped = false;
        const handleClick = () => {
          isFlipped = !isFlipped;
          if (isFlipped) {
            (card as HTMLElement).style.transform = 'rotateY(180deg)';
          } else {
            (card as HTMLElement).style.transform = 'rotateY(0deg)';
          }
        };
        on(card, 'click', handleClick);
      });

      // === MAGNETIC CARD TILT ===
      root.querySelectorAll('.edu-card-wrapper').forEach((wrapper) => {
        const card = wrapper.querySelector('.edu-card') as HTMLElement | null;
        const spotlight = wrapper.querySelector('.edu-spotlight') as HTMLElement | null;
        const holographic = wrapper.querySelector('.edu-holographic') as HTMLElement | null;
        if (!card) return;

        let isFlipped = false;

        const handleMove = (e: Event) => {
          if (isFlipped) return;
          const mouseEvent = e as MouseEvent;
          const rect = (wrapper as HTMLElement).getBoundingClientRect();
          const x = mouseEvent.clientX - rect.left;
          const y = mouseEvent.clientY - rect.top;
          const centerX = rect.width / 2;
          const centerY = rect.height / 2;

          const rotateX = (y - centerY) / 15;
          const rotateY = (centerX - x) / 15;

          card.style.transform = `rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;

          if (spotlight) {
            spotlight.style.opacity = '1';
            spotlight.style.background = `radial-gradient(circle at ${x}px ${y}px, rgba(255,255,255,0.15) 0%, transparent 60%)`;
          }

          if (holographic) {
            holographic.style.background = `
              linear-gradient(
                ${110 + (x / rect.width) * 40}deg,
                transparent 0%,
                hsla(${(x / rect.width) * 360}, 100%, 70%, 0.1) 30%,
                hsla(${((x / rect.width) * 360 + 60) % 360}, 100%, 70%, 0.15) 50%,
                hsla(${((x / rect.width) * 360 + 120) % 360}, 100%, 70%, 0.1) 70%,
                transparent 100%
              )
            `;
          }
        };

        const handleLeave = () => {
          if (!isFlipped) {
            card.style.transform = 'rotateX(0) rotateY(0)';
          }
          if (spotlight) spotlight.style.opacity = '0';
        };

        const handleFlip = () => {
          isFlipped = !isFlipped;
          if (isFlipped) {
            card.style.transform = 'rotateY(180deg)';
          } else {
            card.style.transform = 'rotateY(0deg)';
          }
        };

        on(wrapper, 'mousemove', handleMove);
        on(wrapper, 'mouseleave', handleLeave);
        on(card, 'click', handleFlip);
      });

      // === FLAG 3D ROTATION ===
      root.querySelectorAll('.edu-flag-3d').forEach((flag) => {
        const handleMove = (e: Event) => {
          const mouseEvent = e as MouseEvent;
          const rect = (flag as HTMLElement).getBoundingClientRect();
          const x = mouseEvent.clientX - rect.left - rect.width / 2;
          const y = mouseEvent.clientY - rect.top - rect.height / 2;
          (flag as HTMLElement).style.transform = `rotateY(${x * 0.3}deg) rotateX(${-y * 0.3}deg) scale(1.2)`;
        };
        const handleLeave = () => {
          (flag as HTMLElement).style.transform = 'rotateY(0) rotateX(0) scale(1)';
        };
        on(flag, 'mousemove', handleMove);
        on(flag, 'mouseleave', handleLeave);
      });

      // === REVEAL ANIMATIONS ===
      observer = new IntersectionObserver((entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            entry.target.classList.add('is-visible');

            entry.target.querySelectorAll('.edu-progress-bar').forEach((bar) => {
              const width = (bar as HTMLElement).dataset.width || '0';
              setTimeout(() => {
                (bar as HTMLElement).style.width = `${width}%`;
              }, 600);
            });

            observer?.unobserve(entry.target);
          }
        });
      }, { threshold: 0.4, rootMargin: '-50px 0px -50px 0px' });

      root.querySelectorAll('.edu-reveal').forEach((el) => observer?.observe(el));

      // === PARALLAX ORBS ===
      const orbs = root.querySelectorAll('.edu-orb');
      if (orbs.length) {
        on(root, 'mousemove', (e: Event) => {
          const mouseEvent = e as MouseEvent;
          const rect = (root as HTMLElement).getBoundingClientRect();
          const x = (mouseEvent.clientX - rect.left) / rect.width - 0.5;
          const y = (mouseEvent.clientY - rect.top) / rect.height - 0.5;

          orbs.forEach((orb, i) => {
            const depth = (i + 1) * 20;
            (orb as HTMLElement).style.transform = `translate(${x * depth}px, ${y * depth}px)`;
          });
        });
      }

      // === STAT COUNTER ANIMATION ===
      const stats = root.querySelectorAll('.edu-stat-value');
      statsObserver = new IntersectionObserver((entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            const el = entry.target as HTMLElement;
            const text = el.textContent || '';
            const match = text.match(/(\d+)/);
            if (match) {
              const target = parseInt(match[1], 10);
              let current = 0;
              const increment = target / 30;
              const suffix = text.replace(/\d+/, '');

              const counter = window.setInterval(() => {
                current += increment;
                if (current >= target) {
                  current = target;
                  clearInterval(counter);
                }
                el.textContent = Math.floor(current) + suffix;
              }, 30);
              intervals.push(counter);
            }
            statsObserver?.unobserve(entry.target);
          }
        });
      }, { threshold: 0.5 });

      stats.forEach((stat) => statsObserver?.observe(stat));

      return () => {
        if (animationId !== null) cancelAnimationFrame(animationId);
        intervals.forEach((intervalId) => clearInterval(intervalId));
        observer?.disconnect();
        statsObserver?.disconnect();
        disposers.forEach((dispose) => dispose());
      };
    });
  }

  initEducation();
  document.addEventListener('astro:page-load', initEducation);
</script>

<style>
  /* === SECTION BACKGROUND - THEME ADAPTIVE === */
  .edu-section {
    background: linear-gradient(180deg,
      var(--color-bg) 0%,
      var(--color-bg-alt) 50%,
      var(--color-bg) 100%
    );
  }

  /* === HEADER ELEMENTS - THEME ADAPTIVE === */
  .edu-badge {
    background: rgba(74, 144, 164, 0.1);
    border: 1px solid rgba(74, 144, 164, 0.2);
  }

  :global(.dark) .edu-badge {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(255, 255, 255, 0.1);
  }

  .edu-badge-text {
    color: var(--color-accent);
  }

  :global(.dark) .edu-badge-text {
    color: rgba(255, 255, 255, 0.7);
  }

  .edu-title {
    color: var(--color-text);
  }

  :global(.dark) .edu-title {
    color: #ffffff;
  }

  .edu-subtitle-text {
    color: var(--color-text-muted);
  }

  :global(.dark) .edu-subtitle-text {
    color: rgba(255, 255, 255, 0.6);
  }

  .edu-path-bg {
    background: rgba(0, 0, 0, 0.1);
  }

  :global(.dark) .edu-path-bg {
    background: rgba(255, 255, 255, 0.1);
  }

  /* === CARD BACKGROUNDS - THEME ADAPTIVE === */
  .edu-card-glass {
    background: linear-gradient(135deg,
      rgba(74, 144, 164, 0.05) 0%,
      rgba(255, 255, 255, 0.8) 50%,
      rgba(74, 144, 164, 0.03) 100%
    );
  }

  :global(.dark) .edu-card-glass {
    background: linear-gradient(135deg,
      rgba(255, 255, 255, 0.1) 0%,
      rgba(255, 255, 255, 0.05) 50%,
      transparent 100%
    );
  }

  .edu-card-bg {
    background: rgba(255, 255, 255, 0.95);
  }

  :global(.dark) .edu-card-bg {
    background: rgba(15, 23, 42, 0.9);
  }

  .edu-card-bg-back {
    background: rgba(255, 255, 255, 0.98);
  }

  :global(.dark) .edu-card-bg-back {
    background: rgba(15, 23, 42, 0.95);
  }

  .edu-icon-bg {
    background: rgba(255, 255, 255, 0.95);
  }

  :global(.dark) .edu-icon-bg {
    background: rgb(15, 23, 42);
  }

  .edu-icon-color {
    color: var(--color-text);
  }

  :global(.dark) .edu-icon-color {
    color: #ffffff;
  }

  /* === CARD TEXT COLORS - THEME ADAPTIVE === */
  .edu-card-text {
    color: var(--color-text);
  }

  :global(.dark) .edu-card-text {
    color: #ffffff;
  }

  .edu-card-text-secondary {
    color: var(--color-text);
    opacity: 0.8;
  }

  :global(.dark) .edu-card-text-secondary {
    color: rgba(255, 255, 255, 0.8);
    opacity: 1;
  }

  .edu-card-text-muted {
    color: var(--color-text-muted);
  }

  :global(.dark) .edu-card-text-muted {
    color: rgba(255, 255, 255, 0.6);
  }

  /* === STATUS & YEAR BADGES === */
  .edu-status-bg {
    background: rgba(74, 144, 164, 0.1);
    border: 1px solid rgba(74, 144, 164, 0.2);
  }

  :global(.dark) .edu-status-bg {
    background: rgba(255, 255, 255, 0.1);
    border-color: rgba(255, 255, 255, 0.2);
  }

  .edu-year-bg {
    background: rgba(74, 144, 164, 0.05);
    border: 1px solid rgba(74, 144, 164, 0.1);
  }

  :global(.dark) .edu-year-bg {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(255, 255, 255, 0.1);
  }

  /* === PILLS & PROGRESS === */
  .edu-pill-bg {
    background: rgba(0, 0, 0, 0.05);
    border: 1px solid rgba(0, 0, 0, 0.08);
  }

  :global(.dark) .edu-pill-bg {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(255, 255, 255, 0.1);
  }

  .edu-pill-bg:hover {
    background: rgba(0, 0, 0, 0.1);
    border-color: rgba(0, 0, 0, 0.15);
  }

  :global(.dark) .edu-pill-bg:hover {
    background: rgba(255, 255, 255, 0.1);
    border-color: rgba(255, 255, 255, 0.3);
  }

  .edu-progress-track {
    background: rgba(0, 0, 0, 0.1);
  }

  :global(.dark) .edu-progress-track {
    background: rgba(255, 255, 255, 0.1);
  }

  /* === BANNER === */
  .edu-banner-bg {
    background: rgba(255, 255, 255, 0.9);
    border: 1px solid rgba(0, 0, 0, 0.05);
  }

  :global(.dark) .edu-banner-bg {
    background: rgba(15, 23, 42, 0.8);
    border-color: transparent;
  }

  /* === ORBS - THEME ADAPTIVE OPACITY === */
  .edu-orb {
    opacity: 0.15;
  }

  :global(.dark) .edu-orb {
    opacity: 0.3;
  }

  /* === MORPHING BLOB === */
  .edu-morph-blob {
    opacity: 0.05;
  }

  :global(.dark) .edu-morph-blob {
    opacity: 0.1;
  }

  /* === AURORA BOREALIS === */
  .edu-aurora-layer {
    position: absolute;
    inset: 0;
    opacity: 0.15;
    filter: blur(80px);
  }

  :global(.dark) .edu-aurora-layer {
    opacity: 0.3;
  }

  .edu-aurora-1 {
    background: linear-gradient(180deg, transparent, rgba(110, 231, 183, 0.3), transparent);
    animation: edu-aurora-shift 15s ease-in-out infinite;
  }

  .edu-aurora-2 {
    background: linear-gradient(120deg, transparent, rgba(147, 197, 253, 0.3), transparent);
    animation: edu-aurora-shift 20s ease-in-out infinite reverse;
    animation-delay: -5s;
  }

  .edu-aurora-3 {
    background: linear-gradient(240deg, transparent, rgba(196, 181, 253, 0.2), transparent);
    animation: edu-aurora-shift 25s ease-in-out infinite;
    animation-delay: -10s;
  }

  @keyframes edu-aurora-shift {
    0%, 100% { transform: translateY(-10%) rotate(0deg) scale(1.2); }
    33% { transform: translateY(10%) rotate(5deg) scale(1.1); }
    66% { transform: translateY(-5%) rotate(-3deg) scale(1.15); }
  }

  /* === FLOATING ANIMATION === */
  @keyframes edu-float {
    0%, 100% { transform: translateY(0) translateX(0) rotate(0deg); }
    25% { transform: translateY(-20px) translateX(10px) rotate(2deg); }
    50% { transform: translateY(-10px) translateX(-10px) rotate(-1deg); }
    75% { transform: translateY(-25px) translateX(5px) rotate(1deg); }
  }

  /* === TITLE GLITCH === */
  .edu-title-glitch {
    position: relative;
    text-shadow: 0 0 40px rgba(74, 144, 164, 0.2);
  }

  :global(.dark) .edu-title-glitch {
    text-shadow: 0 0 40px rgba(110, 231, 183, 0.3);
  }

  .edu-title-glitch::before,
  .edu-title-glitch::after {
    content: attr(data-text);
    position: absolute;
    inset: 0;
    opacity: 0;
  }

  .edu-title-glitch:hover::before {
    animation: edu-glitch-1 0.3s ease-in-out;
    color: #4a90a4;
    text-shadow: -2px 0 #4a90a4;
    clip-path: polygon(0 0, 100% 0, 100% 45%, 0 45%);
  }

  :global(.dark) .edu-title-glitch:hover::before {
    color: #6ee7b7;
    text-shadow: -2px 0 #6ee7b7;
  }

  .edu-title-glitch:hover::after {
    animation: edu-glitch-2 0.3s ease-in-out;
    color: #6ab0c4;
    text-shadow: 2px 0 #6ab0c4;
    clip-path: polygon(0 55%, 100% 55%, 100% 100%, 0 100%);
  }

  :global(.dark) .edu-title-glitch:hover::after {
    color: #93c5fd;
    text-shadow: 2px 0 #93c5fd;
  }

  @keyframes edu-glitch-1 {
    0%, 100% { opacity: 0; transform: translateX(0); }
    20% { opacity: 0.8; transform: translateX(-4px); }
    40% { opacity: 0.8; transform: translateX(4px); }
    60% { opacity: 0.8; transform: translateX(-2px); }
    80% { opacity: 0.8; transform: translateX(2px); }
  }

  @keyframes edu-glitch-2 {
    0%, 100% { opacity: 0; transform: translateX(0); }
    20% { opacity: 0.8; transform: translateX(4px); }
    40% { opacity: 0.8; transform: translateX(-4px); }
    60% { opacity: 0.8; transform: translateX(2px); }
    80% { opacity: 0.8; transform: translateX(-2px); }
  }

  /* === GLOBE SPIN === */
  .edu-globe-spin {
    display: inline-block;
    animation: edu-globe-rotate 4s linear infinite;
  }

  @keyframes edu-globe-rotate {
    0% { transform: rotateY(0deg); }
    100% { transform: rotateY(360deg); }
  }

  /* === COUNTRY PATH FLOW === */
  .edu-path-flow {
    animation: edu-flow 2s ease-in-out infinite;
    transform: translateX(-100%);
  }

  @keyframes edu-flow {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
  }

  /* === PULSE RING === */
  .edu-country-node:hover .edu-pulse-ring {
    animation: edu-pulse-expand 1s ease-out infinite;
  }

  @keyframes edu-pulse-expand {
    0% { transform: scale(1); opacity: 0.8; }
    100% { transform: scale(2); opacity: 0; }
  }

  /* === 3D CARD STYLES === */
  .perspective-1000 {
    perspective: 1000px;
  }

  .transform-style-3d {
    transform-style: preserve-3d;
  }

  .backface-hidden {
    backface-visibility: hidden;
  }

  .rotate-y-180 {
    transform: rotateY(180deg);
  }

  .edu-card {
    transition: transform 0.7s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .edu-card-front,
  .edu-card-back {
    transition: box-shadow 0.3s ease;
  }

  .edu-card-wrapper:hover .edu-card-front {
    box-shadow:
      0 25px 50px -12px rgba(0, 0, 0, 0.15),
      0 0 60px -15px var(--accent);
  }

  :global(.dark) .edu-card-wrapper:hover .edu-card-front {
    box-shadow:
      0 25px 50px -12px rgba(0, 0, 0, 0.5),
      0 0 60px -15px var(--accent);
  }

  /* === HOLOGRAPHIC EFFECT === */
  .edu-holographic {
    mix-blend-mode: color-dodge;
    transition: background 0.1s ease;
  }

  /* === ORBITAL ANIMATION === */
  .edu-orbital {
    animation: edu-orbit-spin 10s linear infinite;
  }

  .edu-orbit-dot {
    animation: edu-dot-orbit 3s linear infinite;
  }

  @keyframes edu-orbit-spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  @keyframes edu-dot-orbit {
    0% {
      top: 0;
      left: 50%;
      transform: translate(-50%, -50%);
    }
    25% {
      top: 50%;
      left: 100%;
      transform: translate(-50%, -50%);
    }
    50% {
      top: 100%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
    75% {
      top: 50%;
      left: 0;
      transform: translate(-50%, -50%);
    }
    100% {
      top: 0;
      left: 50%;
      transform: translate(-50%, -50%);
    }
  }

  /* === FLIP ARROW === */
  .edu-flip-arrow {
    animation: edu-flip-hint 2s ease-in-out infinite;
  }

  @keyframes edu-flip-hint {
    0%, 100% { transform: rotate(0deg); }
    50% { transform: rotate(180deg); }
  }

  /* === SKILL PILLS === */
  .edu-skill-pill {
    animation: edu-pill-glow 3s ease-in-out infinite;
  }

  @keyframes edu-pill-glow {
    0%, 100% { box-shadow: 0 0 0 transparent; }
    50% { box-shadow: 0 0 10px rgba(255, 255, 255, 0.1); }
  }

  /* === BANNER HOLOGRAPHIC === */
  .edu-banner-holo {
    background:
      linear-gradient(
        125deg,
        transparent 0%,
        rgba(110, 231, 183, 0.1) 20%,
        rgba(147, 197, 253, 0.1) 40%,
        rgba(196, 181, 253, 0.1) 60%,
        transparent 80%
      );
    background-size: 200% 200%;
    animation: edu-holo-shift 8s linear infinite;
  }

  @keyframes edu-holo-shift {
    0% { background-position: 0% 50%; }
    100% { background-position: 200% 50%; }
  }

  /* === STAT ITEMS === */
  .edu-stat-item {
    opacity: 0;
    transform: translateY(20px);
    transition: all 0.6s ease;
  }

  .edu-stats-banner.is-visible .edu-stat-item {
    opacity: 1;
    transform: translateY(0);
  }

  .edu-stats-banner.is-visible .edu-stat-item:nth-child(1) { transition-delay: 0.1s; }
  .edu-stats-banner.is-visible .edu-stat-item:nth-child(2) { transition-delay: 0.2s; }
  .edu-stats-banner.is-visible .edu-stat-item:nth-child(3) { transition-delay: 0.3s; }

  /* === REVEAL ANIMATIONS === */
  .edu-reveal {
    opacity: 0;
    transform: translateY(40px);
    transition: opacity 0.8s ease, transform 0.8s ease;
  }

  .edu-reveal.is-visible {
    opacity: 1;
    transform: translateY(0);
  }

  .edu-card-wrapper {
    transition-delay: calc(var(--card-index) * 150ms);
  }

  /* === REDUCED MOTION === */
  @media (prefers-reduced-motion: reduce) {
    .edu-aurora-layer,
    .edu-orb,
    .edu-globe-spin,
    .edu-path-flow,
    .edu-orbital,
    .edu-orbit-dot,
    .edu-flip-arrow,
    .edu-skill-pill,
    .edu-banner-holo,
    .edu-morph-path animate {
      animation: none !important;
    }

    .edu-card {
      transition: none !important;
    }

    .edu-reveal {
      opacity: 1 !important;
      transform: none !important;
    }
  }

  /* === RESPONSIVE === */
  @media (max-width: 768px) {
    .edu-world-path {
      flex-wrap: wrap;
    }

    .edu-country-flag {
      font-size: 2rem;
    }

    .edu-path-line {
      display: none;
    }
  }
</style>
